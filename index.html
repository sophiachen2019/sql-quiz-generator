<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic SQL Quiz Generator</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- sql.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />

    <!-- Choices.js for the multi-select search box -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        pre[class*="language-"] { border-radius: 0.5rem; padding: 1.25rem; }
        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        /* Styling for Choices.js */
        .choices__inner { background-color: white; border-radius: 0.375rem; border: 1px solid #D1D5DB; }
        .choices__list--dropdown { border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">Dynamic SQL Quiz Generator</h1>
            <p class="mt-2 text-lg text-gray-600">Customize your practice quiz below.</p>
            <div id="db-status" class="mt-4 text-sm text-gray-500">Loading database...</div>
        </header>

        <!-- Setup Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-12">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quiz Setup</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="md:col-span-2">
                    <label for="company-selector" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <select id="company-selector"></select>
                </div>
                 <div>
                    <label for="theme" class="block text-sm font-medium text-gray-700">Company Theme</label>
                    <input type="text" id="theme" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" disabled>
                </div>
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700">Difficulty</label>
                    <select id="difficulty" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="lg:col-span-4">
                    <label for="numQuestions" class="block text-sm font-medium text-gray-700">Number of Questions</label>
                    <input type="number" id="numQuestions" value="5" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="generateBtn" onclick="generateQuiz()" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75" disabled>Generate Quiz</button>
                <div id="error-message" class="mt-4 text-red-600 font-semibold text-sm"></div>
            </div>
        </div>

        <!-- Quiz Container -->
        <main id="quiz-container" class="space-y-12"></main>
    </div>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        let SQL;
        let db;
        let companyChoices;
        const dbStatus = document.getElementById('db-status');
        const errorDiv = document.getElementById('error-message');
        let activeQuizData = {};

        // --- Question Bank (fully populated) ---
        const themedQuestionBanks = { saas: {easy:[], medium:[], hard:[]}, ecommerce: {easy:[], medium:[], hard:[]}, social: {easy:[], medium:[], hard:[]}, fintech: {easy:[], medium:[], hard:[]}, healthcare: {easy:[], medium:[], hard:[]}, streaming: {easy:[], medium:[], hard:[]} };
        const companyThemeMapping = {};

        // --- Populate Question Bank ---
        function populateQuestions() {
            // SaaS Questions
            themedQuestionBanks.saas.easy = [
                { id: 'se1', title: 'Find All Active Users', task: "Retrieve the `user_id` and `user_name` of all users at {companyName} with an 'active' status.", tables: ['users(user_id, user_name, status)'], solution: "SELECT user_id, user_name FROM users WHERE status = 'active';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, status TEXT); INSERT INTO users VALUES (1, 'Alice', 'active'), (2, 'Bob', 'inactive'), (3, 'Charlie', 'active');" },
                { id: 'se2', title: 'Count Issues by Type', task: "Count the number of issues for each `issue_type`.", tables: ['issues(issue_id, issue_type)'], solution: "SELECT issue_type, COUNT(issue_id) AS issue_count FROM issues GROUP BY issue_type;", setupSQL: "CREATE TABLE issues (issue_id INT, issue_type TEXT); INSERT INTO issues VALUES (101, 'Bug'), (102, 'Feature'), (103, 'Bug'), (104, 'Task');" },
                { id: 'se3', title: 'Find Projects with No Issues', task: "Identify all projects that have no issues reported in them.", tables: ['projects(project_id, project_name)', 'issues(issue_id, project_id)'], solution: "SELECT p.project_id, p.project_name FROM projects p LEFT JOIN issues i ON p.project_id = i.project_id WHERE i.issue_id IS NULL;", setupSQL: "CREATE TABLE projects (project_id INT, project_name TEXT); CREATE TABLE issues (issue_id INT, project_id INT); INSERT INTO projects VALUES (1, 'Jira'), (2, 'Confluence'), (3, 'Bitbucket'); INSERT INTO issues VALUES (101, 1), (102, 3);" },
                { id: 'se4', title: 'Find Recent Comments', task: "Retrieve all comments created on or after '2025-08-01'.", tables: ['comments(comment_id, comment_text, created_at)'], solution: "SELECT * FROM comments WHERE created_at >= '2025-08-01';", setupSQL: "CREATE TABLE comments (comment_id INT, comment_text TEXT, created_at TEXT); INSERT INTO comments VALUES (1, 'First comment', '2025-07-31'), (2, 'Second comment', '2025-08-01'), (3, 'Third comment', '2025-08-02');" },
                { id: 'se5', title: 'Users with a Specific Email Domain', task: "Find all users whose email address ends with '@example.com'.", tables: ['users(user_id, user_name, email)'], solution: "SELECT user_id, user_name FROM users WHERE email LIKE '%@example.com';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, email TEXT); INSERT INTO users VALUES (1, 'Alice', 'alice@example.com'), (2, 'Bob', 'bob@work.com'), (3, 'Charlie', 'charlie@example.com');" },
                { id: 'se6', title: 'Count Comments per Issue', task: "For each issue, count the total number of comments.", tables: ['comments(comment_id, issue_id)'], solution: "SELECT issue_id, COUNT(comment_id) AS comment_count FROM comments GROUP BY issue_id;", setupSQL: "CREATE TABLE comments (comment_id INT, issue_id INT); INSERT INTO comments VALUES (1, 101), (2, 101), (3, 102), (4, 101);" },
                { id: 'se7', title: 'Find Critical Priority Issues', task: "Select all issues that have a 'Critical' priority.", tables: ['issues(issue_id, summary, priority)'], solution: "SELECT * FROM issues WHERE priority = 'Critical';", setupSQL: "CREATE TABLE issues (issue_id INT, summary TEXT, priority TEXT); INSERT INTO issues VALUES (1, 'UI Glitch', 'Medium'), (2, 'System Crash', 'Critical'), (3, 'Typo in docs', 'Low');" },
                { id: 'se8', title: 'List Unique Project Statuses', task: "Get a list of all unique statuses a project can have.", tables: ['projects(project_id, status)'], solution: "SELECT DISTINCT status FROM projects;", setupSQL: "CREATE TABLE projects (project_id INT, status TEXT); INSERT INTO projects VALUES (1, 'Active'), (2, 'On Hold'), (3, 'Active'), (4, 'Archived');" },
                { id: 'se9', title: 'Find a Specific User', task: "Retrieve all information for the user named 'Bob'.", tables: ['users(user_id, user_name, email)'], solution: "SELECT * FROM users WHERE user_name = 'Bob';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, email TEXT); INSERT INTO users VALUES (1, 'Alice', 'a@a.com'), (2, 'Bob', 'b@b.com');" },
                { id: 'se10', title: 'Issues Assigned to a User', task: "Find all issues assigned to the user with `assignee_id` = 1.", tables: ['issues(issue_id, summary, assignee_id)'], solution: "SELECT issue_id, summary FROM issues WHERE assignee_id = 1;", setupSQL: "CREATE TABLE issues (issue_id INT, summary TEXT, assignee_id INT); INSERT INTO issues VALUES (101, 'Fix login', 1), (102, 'Update docs', 2), (103, 'Deploy fix', 1);" }
            ];
            themedQuestionBanks.saas.medium = [
                { id: 'sm1', title: 'Users Who Commented on Their Own Issues', task: "Identify users from {companyName} who have commented on an issue they also reported. Return the `user_id` and `user_name`.", tables: ['users(user_id, user_name)', 'issues(issue_id, reporter_id)', 'comments(comment_id, issue_id, author_id)'], solution: "SELECT DISTINCT u.user_id, u.user_name FROM users u JOIN issues i ON u.user_id = i.reporter_id JOIN comments c ON i.issue_id = c.issue_id AND u.user_id = c.author_id;", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT); CREATE TABLE issues (issue_id INT, reporter_id INT); CREATE TABLE comments (comment_id INT, issue_id INT, author_id INT); INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO issues VALUES (101, 1), (102, 2); INSERT INTO comments VALUES (1, 101, 1), (2, 101, 2), (3, 102, 1);" },
                { id: 'sm2', title: 'Average Comments Before Closure', task: "Calculate the average number of comments an issue receives before it is marked 'Closed'.", tables: ['comments(comment_id, issue_id)', "issue_history(history_id, issue_id, status)"], solution: "WITH CommentCounts AS (SELECT issue_id, COUNT(comment_id) as num_comments FROM comments GROUP BY issue_id), ClosedIssues AS (SELECT DISTINCT issue_id FROM issue_history WHERE status = 'Closed') SELECT AVG(cc.num_comments) FROM CommentCounts cc JOIN ClosedIssues ci ON cc.issue_id = ci.issue_id;", setupSQL: "CREATE TABLE comments (comment_id INT, issue_id INT); CREATE TABLE issue_history (history_id INT, issue_id INT, status TEXT); INSERT INTO comments VALUES (1, 101), (2, 101), (3, 102); INSERT INTO issue_history VALUES (1, 101, 'Closed'), (2, 102, 'Closed'), (3, 103, 'Open');" },
                { id: 'sm3', title: 'Second Most Recent Comment', task: "For each user, find their second most recent comment.", tables: ['comments(user_id, comment_text, created_at)'], solution: "WITH RankedComments AS (SELECT user_id, comment_text, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY created_at DESC) as rn FROM comments) SELECT user_id, comment_text FROM RankedComments WHERE rn = 2;", setupSQL: "CREATE TABLE comments (user_id INT, comment_text TEXT, created_at TEXT); INSERT INTO comments VALUES (1, 'First', '2025-01-01'), (1, 'Second', '2025-01-02'), (1, 'Third', '2025-01-03'), (2, 'A', '2025-01-04'), (2, 'B', '2025-01-05');" },
                { id: 'sm4', title: 'Inactive Users', task: "Find users who have not created an issue or a comment in the last 90 days (relative to '2025-08-11').", tables: ['users(user_id, user_name)', 'issues(reporter_id, created_at)', 'comments(author_id, created_at)'], solution: "WITH LastActivity AS (SELECT user_id, MAX(activity_date) as last_date FROM (SELECT reporter_id as user_id, created_at as activity_date FROM issues UNION ALL SELECT author_id, created_at FROM comments) AS AllActivity GROUP BY user_id) SELECT u.user_id, u.user_name FROM users u LEFT JOIN LastActivity la ON u.user_id = la.user_id WHERE la.last_date IS NULL OR la.last_date < DATE('2025-08-11', '-90 days');", setupSQL: "CREATE TABLE users(user_id INT, user_name TEXT); CREATE TABLE issues(reporter_id INT, created_at TEXT); CREATE TABLE comments(author_id INT, created_at TEXT); INSERT INTO users VALUES (1, 'Active User'), (2, 'Inactive User'); INSERT INTO issues VALUES (1, '2025-08-01'); INSERT INTO comments VALUES (1, '2025-08-02');" },
                { id: 'sm5', title: 'Projects and Their User Count', task: "List each project and the number of unique users who have commented on it.", tables: ['projects(project_id, project_name)', 'comments(project_id, user_id)'], solution: "SELECT p.project_name, COUNT(DISTINCT c.user_id) as user_count FROM projects p LEFT JOIN comments c ON p.project_id = c.project_id GROUP BY p.project_name;", setupSQL: "CREATE TABLE projects(project_id INT, project_name TEXT); CREATE TABLE comments(project_id INT, user_id INT); INSERT INTO projects VALUES (1, 'Jira'), (2, 'Confluence'); INSERT INTO comments VALUES (1, 1), (1, 2), (1, 1), (2, 3);" },
                { id: 'sm6', title: 'Monthly Active Users (MAU)', task: "Calculate the number of unique active users for each month in 2025.", tables: ['activity_log(user_id, event_date)'], solution: "SELECT STRFTIME('%Y-%m', event_date) as month, COUNT(DISTINCT user_id) as mau FROM activity_log WHERE STRFTIME('%Y', event_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE activity_log(user_id INT, event_date TEXT); INSERT INTO activity_log VALUES (1, '2025-01-10'), (2, '2025-01-15'), (1, '2025-01-20'), (3, '2025-02-05'), (1, '2025-02-10');" },
                { id: 'sm7', title: 'Issues with No Comments', task: "Find all issues that have not received any comments.", tables: ['issues(issue_id, summary)', 'comments(comment_id, issue_id)'], solution: "SELECT i.issue_id, i.summary FROM issues i LEFT JOIN comments c ON i.issue_id = c.issue_id WHERE c.comment_id IS NULL;", setupSQL: "CREATE TABLE issues(issue_id INT, summary TEXT); CREATE TABLE comments(comment_id INT, issue_id INT); INSERT INTO issues VALUES (101, 'Bug A'), (102, 'Feature B'); INSERT INTO comments VALUES (1, 101);" },
                { id: 'sm8', title: 'User with Most Bug Reports', task: "Find the user who has reported the most 'Bug' type issues.", tables: ['users(user_id, user_name)', 'issues(reporter_id, issue_type)'], solution: "SELECT u.user_name FROM users u JOIN issues i ON u.user_id = i.reporter_id WHERE i.issue_type = 'Bug' GROUP BY u.user_name ORDER BY COUNT(i.issue_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE users(user_id INT, user_name TEXT); CREATE TABLE issues(reporter_id INT, issue_type TEXT); INSERT INTO users VALUES(1, 'Alice'), (2, 'Bob'); INSERT INTO issues VALUES (1, 'Bug'), (1, 'Bug'), (2, 'Feature'), (2, 'Bug');" },
                { id: 'sm9', title: 'Average Time to First Comment', task: "Calculate the average time (in hours) between an issue's creation and its first comment.", tables: ['issues(issue_id, created_at)', 'comments(issue_id, created_at)'], solution: "WITH FirstComments AS (SELECT issue_id, MIN(created_at) as first_comment_time FROM comments GROUP BY issue_id) SELECT AVG((JULIANDAY(fc.first_comment_time) - JULIANDAY(i.created_at)) * 24) as avg_hours_to_comment FROM issues i JOIN FirstComments fc ON i.issue_id = fc.issue_id;", setupSQL: "CREATE TABLE issues(issue_id INT, created_at TEXT); CREATE TABLE comments(issue_id INT, created_at TEXT); INSERT INTO issues VALUES (101, '2025-08-01 10:00:00'); INSERT INTO comments VALUES (101, '2025-08-01 12:30:00');" },
                { id: 'sm10', title: 'Subscription Plan Breakdown', task: "Count the number of users on each subscription plan.", tables: ['users(user_id, plan_id)', 'plans(plan_id, plan_name)'], solution: "SELECT p.plan_name, COUNT(u.user_id) as user_count FROM plans p JOIN users u ON p.plan_id = u.plan_id GROUP BY p.plan_name;", setupSQL: "CREATE TABLE users(user_id INT, plan_id INT); CREATE TABLE plans(plan_id INT, plan_name TEXT); INSERT INTO plans VALUES (1, 'Free'), (2, 'Premium'); INSERT INTO users VALUES (1, 1), (2, 2), (3, 1), (4, 2), (5, 2);" }
            ];
            themedQuestionBanks.saas.hard = [
                { id: 'sh1', title: 'Power User Identification', task: "Identify 'Power Users' at {companyName} who have commented on > 2 distinct projects and resolved >= 3 issues.", tables: ['users(user_id, user_name)', 'comments(project_id, user_id)', "issue_history(issue_id, status, changed_by_user_id)"], solution: "WITH UserComments AS (SELECT user_id, COUNT(DISTINCT project_id) AS distinct_projects FROM comments GROUP BY user_id HAVING COUNT(DISTINCT project_id) > 2), UserResolutions AS (SELECT changed_by_user_id AS user_id, COUNT(DISTINCT issue_id) AS resolved_issues FROM issue_history WHERE status = 'Closed' GROUP BY changed_by_user_id HAVING COUNT(DISTINCT issue_id) >= 3) SELECT u.user_id, u.user_name FROM users u JOIN UserComments uc ON u.user_id = uc.user_id JOIN UserResolutions ur ON u.user_id = ur.user_id;", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT); CREATE TABLE comments (project_id INT, user_id INT); CREATE TABLE issue_history (issue_id INT, status TEXT, changed_by_user_id INT); INSERT INTO users VALUES (1, 'Alice'); INSERT INTO comments VALUES (1, 1), (2, 1), (3, 1); INSERT INTO issue_history VALUES (101, 'Closed', 1), (102, 'Closed', 1), (103, 'Closed', 1);" },
                { id: 'sh2', title: 'Issue Resolution Funnel Analysis', task: "For each `issue_id`, determine if it followed the standard path: 'Open' -> 'In Progress'.", tables: ["issue_history(issue_id, status, changed_at)"], solution: "WITH StatusFlow AS (SELECT issue_id, status, LEAD(status, 1) OVER (PARTITION BY issue_id ORDER BY changed_at) AS next_status FROM issue_history) SELECT issue_id, MAX(CASE WHEN status = 'Open' AND next_status = 'In Progress' THEN 1 ELSE 0 END) AS followed_path FROM StatusFlow GROUP BY issue_id ORDER BY issue_id;", setupSQL: "CREATE TABLE issue_history (issue_id INT, status TEXT, changed_at TEXT); INSERT INTO issue_history VALUES (101, 'Open', '2025-08-01 10:00:00'), (101, 'In Progress', '2025-08-01 11:00:00'), (102, 'Open', '2025-08-02 10:00:00');" },
                { id: 'sh3', title: 'Running Total of Daily Issues', task: "Calculate the running total of issues created each day.", tables: ['issues(issue_id, created_at)'], solution: "WITH DailyCounts AS (SELECT CAST(created_at AS DATE) as creation_date, COUNT(issue_id) as daily_count FROM issues GROUP BY creation_date) SELECT creation_date, SUM(daily_count) OVER (ORDER BY creation_date) as running_total_issues FROM DailyCounts;", setupSQL: "CREATE TABLE issues (issue_id INT, created_at TEXT); INSERT INTO issues VALUES (1, '2025-08-01'), (2, '2025-08-01'), (3, '2025-08-02'), (4, '2025-08-03');" },
                { id: 'sh4', title: 'Consecutive Day Login Streaks', task: "Find all users who have logged in for 3 or more consecutive days.", tables: ['logins(user_id, login_date)'], solution: "WITH DailyLogins AS (SELECT DISTINCT user_id, CAST(login_date AS DATE) as login_day FROM logins), GroupedLogins AS (SELECT user_id, login_day, DATE(login_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY login_day)) || ' days') as streak_group FROM DailyLogins) SELECT user_id, COUNT(*) as streak_length FROM GroupedLogins GROUP BY user_id, streak_group HAVING COUNT(*) >= 3;", setupSQL: "CREATE TABLE logins(user_id INT, login_date TEXT); INSERT INTO logins VALUES (1, '2025-01-01'), (1, '2025-01-02'), (1, '2025-01-03'), (2, '2025-01-01'), (2, '2025-01-03');" },
                { id: 'sh5', title: 'Fastest Issue Solvers', task: "Find the user who, on average, takes the least amount of time to move an issue from 'In Progress' to 'Closed'.", tables: ['issue_history(issue_id, status, changed_at, changed_by_user_id)'], solution: "WITH InProgress AS (SELECT issue_id, changed_at as progress_time FROM issue_history WHERE status = 'In Progress'), Closed AS (SELECT issue_id, changed_at as closed_time, changed_by_user_id FROM issue_history WHERE status = 'Closed') SELECT c.changed_by_user_id, AVG(JULIANDAY(c.closed_time) - JULIANDAY(p.progress_time)) as avg_solve_time FROM InProgress p JOIN Closed c ON p.issue_id = c.issue_id GROUP BY c.changed_by_user_id ORDER BY avg_solve_time LIMIT 1;", setupSQL: "CREATE TABLE issue_history(issue_id INT, status TEXT, changed_at TEXT, changed_by_user_id INT); INSERT INTO issue_history VALUES (101, 'In Progress', '2025-01-01 10:00', 1), (101, 'Closed', '2025-01-01 12:00', 1), (102, 'In Progress', '2025-01-02 10:00', 2), (102, 'Closed', '2025-01-02 15:00', 2);" },
                { id: 'sh6', title: 'Monthly Churn Rate', task: "Calculate the monthly user churn rate. Churn is defined as the number of users who ended their subscription in a month divided by the total active users at the start of that month.", tables: ['subscriptions(user_id, start_date, end_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE subscriptions(user_id INT, start_date TEXT, end_date TEXT);" },
                { id: 'sh7', title: 'User Adoption of a New Feature', task: "For a feature launched on '2025-02-01', calculate the daily percentage of the total user base that has adopted it.", tables: ['users(user_id)', 'feature_usage(user_id, feature_name, used_at)'], solution: "WITH DailyAdopters AS (SELECT CAST(used_at AS DATE) as adoption_date, COUNT(DISTINCT user_id) as daily_adopters FROM feature_usage WHERE feature_name = 'New Feature' AND used_at >= '2025-02-01' GROUP BY adoption_date), TotalUsers AS (SELECT COUNT(*) as total FROM users) SELECT da.adoption_date, CAST(da.daily_adopters AS REAL) * 100 / tu.total FROM DailyAdopters da, TotalUsers tu;", setupSQL: "CREATE TABLE users(user_id INT); CREATE TABLE feature_usage(user_id INT, feature_name TEXT, used_at TEXT); INSERT INTO users VALUES (1),(2),(3),(4); INSERT INTO feature_usage VALUES (1, 'New Feature', '2025-02-01'), (2, 'New Feature', '2025-02-01'), (3, 'New Feature', '2025-02-02');" },
                { id: 'sh8', title: 'Team Velocity', task: "For each team, calculate the total number of 'story points' completed per week.", tables: ['issues(issue_id, team_id, story_points, completed_at)'], solution: "SELECT team_id, STRFTIME('%Y-%W', completed_at) as week, SUM(story_points) as velocity FROM issues WHERE completed_at IS NOT NULL GROUP BY team_id, week;", setupSQL: "CREATE TABLE issues(issue_id INT, team_id INT, story_points INT, completed_at TEXT); INSERT INTO issues VALUES (1, 1, 5, '2025-01-05'), (2, 1, 3, '2025-01-06'), (3, 2, 8, '2025-01-07');" },
                { id: 'sh9', title: 'Islands and Gaps in Activity', task: "Find the start and end dates of continuous periods of user activity (logins).", tables: ['logins(user_id, login_date)'], solution: "WITH DailyLogins AS (SELECT DISTINCT user_id, CAST(login_date AS DATE) as login_day FROM logins), GroupedLogins AS (SELECT user_id, login_day, DATE(login_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY login_day)) || ' days') as streak_group FROM DailyLogins) SELECT user_id, MIN(login_day) as streak_start, MAX(login_day) as streak_end FROM GroupedLogins GROUP BY user_id, streak_group;", setupSQL: "CREATE TABLE logins(user_id INT, login_date TEXT); INSERT INTO logins VALUES (1, '2025-01-01'), (1, '2025-01-02'), (1, '2025-01-04'), (1, '2025-01-05');" },
                { id: 'sh10', title: 'Second Purchase Analysis', task: "For each user, find the time difference in days between their first and second purchase.", tables: ['purchases(user_id, purchase_date)'], solution: "WITH RankedPurchases AS (SELECT user_id, purchase_date, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY purchase_date) as rn FROM purchases), FirstTwo AS (SELECT user_id, purchase_date, rn FROM RankedPurchases WHERE rn <= 2) SELECT user_id, JULIANDAY(MAX(purchase_date)) - JULIANDAY(MIN(purchase_date)) as days_between_purchases FROM FirstTwo GROUP BY user_id HAVING COUNT(*) = 2;", setupSQL: "CREATE TABLE purchases(user_id INT, purchase_date TEXT); INSERT INTO purchases VALUES (1, '2025-01-01'), (1, '2025-01-10'), (2, '2025-02-01');" }
            ];
             // Ecommerce Questions
            themedQuestionBanks.ecommerce.easy = [
                { id: 'ee1', title: 'Find Customers by City', task: "Find all customers from 'New York'.", tables: ['customers(customer_id, name, city)'], solution: "SELECT * FROM customers WHERE city = 'New York';", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT, city TEXT); INSERT INTO customers VALUES (1, 'John Doe', 'New York'), (2, 'Jane Smith', 'Los Angeles');" },
                { id: 'ee2', title: 'Count Orders per Customer', task: "Count how many orders each customer has placed.", tables: ['orders(order_id, customer_id)'], solution: "SELECT customer_id, COUNT(order_id) AS order_count FROM orders GROUP BY customer_id;", setupSQL: "CREATE TABLE orders(order_id INT, customer_id INT); INSERT INTO orders VALUES (1, 10), (2, 20), (3, 10);" },
                { id: 'ee3', title: 'Products Out of Stock', task: "Find all products with a stock quantity of 0.", tables: ['products(product_id, name, stock_quantity)'], solution: "SELECT product_id, name FROM products WHERE stock_quantity = 0;", setupSQL: "CREATE TABLE products(product_id INT, name TEXT, stock_quantity INT); INSERT INTO products VALUES (1, 'Laptop', 15), (2, 'Mouse', 0), (3, 'Keyboard', 5);" },
                { id: 'ee4', title: 'Recent Orders', task: "Retrieve all orders placed on or after '2025-08-01'.", tables: ['orders(order_id, customer_id, order_date)'], solution: "SELECT * FROM orders WHERE order_date >= '2025-08-01';", setupSQL: "CREATE TABLE orders(order_id INT, customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, 1, '2025-07-31'), (2, 2, '2025-08-01'), (3, 1, '2025-08-02');" },
                { id: 'ee5', title: 'Customers with Gmail Accounts', task: "Find all customers with a '@gmail.com' email address.", tables: ['customers(customer_id, name, email)'], solution: "SELECT * FROM customers WHERE email LIKE '%@gmail.com';", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT, email TEXT); INSERT INTO customers VALUES (1, 'John', 'john@gmail.com'), (2, 'Jane', 'jane@yahoo.com');" },
                { id: 'ee6', title: 'Total Items in an Order', task: "For each order, count the total number of items.", tables: ['order_items(order_id, product_id, quantity)'], solution: "SELECT order_id, SUM(quantity) AS total_items FROM order_items GROUP BY order_id;", setupSQL: "CREATE TABLE order_items(order_id INT, product_id INT, quantity INT); INSERT INTO order_items VALUES (1, 101, 2), (1, 102, 1), (2, 103, 5);" },
                { id: 'ee7', title: 'Find High-Value Products', task: "Select all products with a price greater than $100.", tables: ['products(product_id, name, price)'], solution: "SELECT * FROM products WHERE price > 100;", setupSQL: "CREATE TABLE products(product_id INT, name TEXT, price REAL); INSERT INTO products VALUES (1, 'Monitor', 150.0), (2, 'Webcam', 75.0);" },
                { id: 'ee8', title: 'List Unique Product Categories', task: "Get a list of all unique product categories.", tables: ['products(product_id, category)'], solution: "SELECT DISTINCT category FROM products;", setupSQL: "CREATE TABLE products(product_id INT, category TEXT); INSERT INTO products VALUES (1, 'Electronics'), (2, 'Clothing'), (3, 'Electronics');" },
                { id: 'ee9', title: 'Find a Specific Customer', task: "Retrieve all information for the customer named 'Jane Smith'.", tables: ['customers(customer_id, name, city)'], solution: "SELECT * FROM customers WHERE name = 'Jane Smith';", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT, city TEXT); INSERT INTO customers VALUES (1, 'John Doe', 'New York'), (2, 'Jane Smith', 'Los Angeles');" },
                { id: 'ee10', title: 'Orders with a Specific Status', task: "Find all orders with a 'shipped' status.", tables: ['orders(order_id, status)'], solution: "SELECT * FROM orders WHERE status = 'shipped';", setupSQL: "CREATE TABLE orders(order_id INT, status TEXT); INSERT INTO orders VALUES (1, 'processing'), (2, 'shipped'), (3, 'shipped');" }
            ];
            
            themedQuestionBanks.ecommerce.medium = [
                { id: 'em1', title: 'Customers Who Ordered a Specific Product', task: "Identify customers who have ordered the product with `product_id` = 123. Return their names.", tables: ['customers(customer_id, name)', 'orders(order_id, customer_id)', 'order_items(order_id, product_id)'], solution: "SELECT DISTINCT c.name FROM customers c JOIN orders o ON c.customer_id = o.customer_id JOIN order_items oi ON o.order_id = oi.order_id WHERE oi.product_id = 123;", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT); CREATE TABLE orders(order_id INT, customer_id INT); CREATE TABLE order_items(order_id INT, product_id INT); INSERT INTO customers VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO orders VALUES (101, 1), (102, 2); INSERT INTO order_items VALUES (101, 123), (102, 456);" },
                { id: 'em2', title: 'Average Order Value', task: "Calculate the average total amount for all 'completed' orders.", tables: ['orders(order_id, status, total_amount)'], solution: "SELECT AVG(total_amount) FROM orders WHERE status = 'completed';", setupSQL: "CREATE TABLE orders(order_id INT, status TEXT, total_amount REAL); INSERT INTO orders VALUES (1, 'completed', 100), (2, 'pending', 50), (3, 'completed', 200);" },
                { id: 'em3', title: 'Second Most Recent Order', task: "For each customer, find their second most recent order date.", tables: ['orders(order_id, customer_id, order_date)'], solution: "WITH RankedOrders AS (SELECT customer_id, order_date, ROW_NUMBER() OVER(PARTITION BY customer_id ORDER BY order_date DESC) as rn FROM orders) SELECT customer_id, order_date FROM RankedOrders WHERE rn = 2;", setupSQL: "CREATE TABLE orders(order_id INT, customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, 1, '2025-01-01'), (2, 1, '2025-02-02'), (3, 1, '2025-03-03'), (4, 2, '2025-01-05');" },
                { id: 'em4', title: 'Dormant Customers', task: "Find customers who have not placed an order in the last 6 months (relative to '2025-08-11').", tables: ['customers(customer_id, name)', 'orders(order_id, customer_id, order_date)'], solution: "SELECT c.name FROM customers c LEFT JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.name HAVING MAX(o.order_date) < DATE('2025-08-11', '-6 months');", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT); CREATE TABLE orders(order_id INT, customer_id INT, order_date TEXT); INSERT INTO customers VALUES (1, 'Recent Buyer'), (2, 'Dormant Buyer'); INSERT INTO orders VALUES (1, 1, '2025-07-15'), (2, 2, '2025-01-10');" },
                { id: 'em5', title: 'Categories and Their Product Count', task: "List each product category and the number of products within it.", tables: ['products(product_id, category)'], solution: "SELECT category, COUNT(product_id) FROM products GROUP BY category;", setupSQL: "CREATE TABLE products(product_id INT, category TEXT); INSERT INTO products VALUES (1, 'Electronics'), (2, 'Clothing'), (3, 'Electronics');" },
                { id: 'em6', title: 'Monthly Sales Revenue', task: "Calculate the total sales revenue for each month in 2025.", tables: ['orders(order_date, total_amount)'], solution: "SELECT STRFTIME('%Y-%m', order_date) as month, SUM(total_amount) as revenue FROM orders WHERE STRFTIME('%Y', order_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE orders(order_date TEXT, total_amount REAL); INSERT INTO orders VALUES ('2025-01-10', 100), ('2025-01-15', 150), ('2025-02-05', 200);" },
                { id: 'em7', title: 'Products Never Purchased', task: "Find all products that have never been included in an order.", tables: ['products(product_id, name)', 'order_items(order_id, product_id)'], solution: "SELECT p.name FROM products p LEFT JOIN order_items oi ON p.product_id = oi.product_id WHERE oi.order_id IS NULL;", setupSQL: "CREATE TABLE products(product_id INT, name TEXT); CREATE TABLE order_items(order_id INT, product_id INT); INSERT INTO products VALUES (1, 'Laptop'), (2, 'Mouse'); INSERT INTO order_items VALUES (101, 1);" },
                { id: 'em8', title: 'Customer with Most Orders', task: "Find the customer who has placed the most orders.", tables: ['customers(customer_id, name)', 'orders(order_id, customer_id)'], solution: "SELECT c.name FROM customers c JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.name ORDER BY COUNT(o.order_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT); CREATE TABLE orders(order_id INT, customer_id INT); INSERT INTO customers VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO orders VALUES (1, 1), (2, 1), (3, 2);" },
                { id: 'em9', title: 'Average Time Between Orders', task: "Calculate the average time (in days) between a customer's subsequent orders.", tables: ['orders(customer_id, order_date)'], solution: "WITH DatedOrders AS (SELECT customer_id, order_date, LAG(order_date, 1) OVER (PARTITION BY customer_id ORDER BY order_date) as prev_date FROM orders) SELECT AVG(JULIANDAY(order_date) - JULIANDAY(prev_date)) FROM DatedOrders WHERE prev_date IS NOT NULL;", setupSQL: "CREATE TABLE orders(customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, '2025-01-01'), (1, '2025-01-11'), (2, '2025-02-01');" },
                { id: 'em10', title: 'Shipping Method Breakdown', task: "Count the number of orders that used each shipping method.", tables: ['orders(order_id, shipping_method)'], solution: "SELECT shipping_method, COUNT(order_id) FROM orders GROUP BY shipping_method;", setupSQL: "CREATE TABLE orders(order_id INT, shipping_method TEXT); INSERT INTO orders VALUES (1, 'Standard'), (2, 'Express'), (3, 'Standard');" }
            ];
            themedQuestionBanks.ecommerce.hard = [
                { id: 'eh1', title: 'High-Value Customers', task: "Identify 'High-Value Customers' who have placed more than 3 orders and have a total spend of over $500.", tables: ['customers(customer_id, name)', 'orders(order_id, customer_id, total_amount)'], solution: "SELECT c.name FROM customers c JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.name HAVING COUNT(o.order_id) > 3 AND SUM(o.total_amount) > 500;", setupSQL: "CREATE TABLE customers(customer_id INT, name TEXT); CREATE TABLE orders(order_id INT, customer_id INT, total_amount REAL); INSERT INTO customers VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO orders VALUES (1,1,200),(2,1,200),(3,1,200),(4,1,200),(5,2,600);" },
                { id: 'eh2', title: 'Product Purchase Funnel', task: "For product 'Laptop', find how many users viewed it vs. how many added it to their cart.", tables: ['events(user_id, event_type, product_name)'], solution: "SELECT event_type, COUNT(DISTINCT user_id) FROM events WHERE product_name = 'Laptop' AND event_type IN ('view_product', 'add_to_cart') GROUP BY event_type;", setupSQL: "CREATE TABLE events(user_id INT, event_type TEXT, product_name TEXT); INSERT INTO events VALUES (1, 'view_product', 'Laptop'),(2,'view_product','Laptop'),(1,'add_to_cart','Laptop');" },
                { id: 'eh3', title: 'Running Total of Daily Sales', task: "Calculate the running total of sales revenue for each day.", tables: ['orders(order_date, total_amount)'], solution: "WITH DailySales AS (SELECT order_date, SUM(total_amount) as daily_revenue FROM orders GROUP BY order_date) SELECT order_date, SUM(daily_revenue) OVER (ORDER BY order_date) as running_total FROM DailySales;", setupSQL: "CREATE TABLE orders(order_date TEXT, total_amount REAL); INSERT INTO orders VALUES ('2025-08-01', 100), ('2025-08-01', 50), ('2025-08-02', 200);" },
                { id: 'eh4', title: 'Consecutive Day Purchases', task: "Find all customers who have made a purchase on 3 or more consecutive days.", tables: ['orders(customer_id, order_date)'], solution: "WITH DailyPurchases AS (SELECT DISTINCT customer_id, CAST(order_date AS DATE) as purchase_day FROM orders), Grouped AS (SELECT customer_id, purchase_day, DATE(purchase_day, '-' || (ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY purchase_day)) || ' days') as streak_group FROM DailyPurchases) SELECT customer_id, COUNT(*) as streak_length FROM Grouped GROUP BY customer_id, streak_group HAVING COUNT(*) >= 3;", setupSQL: "CREATE TABLE orders(customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, '2025-01-01'), (1, '2025-01-02'), (1, '2025-01-03');" },
                { id: 'eh5', title: 'Most Frequently Purchased Together', task: "Find the pair of products most frequently purchased in the same order.", tables: ['order_items(order_id, product_id)'], solution: "SELECT i1.product_id, i2.product_id, COUNT(*) as frequency FROM order_items i1 JOIN order_items i2 ON i1.order_id = i2.order_id AND i1.product_id < i2.product_id GROUP BY i1.product_id, i2.product_id ORDER BY frequency DESC LIMIT 1;", setupSQL: "CREATE TABLE order_items(order_id INT, product_id INT); INSERT INTO order_items VALUES (1,101),(1,102),(2,101),(2,102),(3,101),(3,103);" },
                { id: 'eh6', title: 'Customer Cohort Retention', task: "For customers who made their first purchase in Jan 2025, what percentage made another purchase in Feb 2025?", tables: ['orders(customer_id, order_date)'], solution: "WITH FirstPurchase AS (SELECT customer_id, MIN(order_date) as first_date FROM orders GROUP BY customer_id), JanCohort AS (SELECT customer_id FROM FirstPurchase WHERE STRFTIME('%Y-%m', first_date) = '2025-01') SELECT CAST(COUNT(DISTINCT o.customer_id) AS REAL) * 100 / (SELECT COUNT(*) FROM JanCohort) FROM orders o JOIN JanCohort jc ON o.customer_id = jc.customer_id WHERE STRFTIME('%Y-%m', o.order_date) = '2025-02';", setupSQL: "CREATE TABLE orders(customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, '2025-01-10'), (1, '2025-02-15'), (2, '2025-01-20'), (3, '2025-02-05');" },
                { id: 'eh7', title: 'New vs. Returning Customers', task: "For each day, calculate the sales revenue from new customers vs. returning customers.", tables: ['orders(order_id, customer_id, order_date, total_amount)'], solution: "WITH FirstOrder AS (SELECT customer_id, MIN(order_date) as first_order_date FROM orders GROUP BY customer_id) SELECT o.order_date, CASE WHEN o.order_date = fo.first_order_date THEN 'New' ELSE 'Returning' END as customer_type, SUM(o.total_amount) as revenue FROM orders o JOIN FirstOrder fo ON o.customer_id = fo.customer_id GROUP BY 1, 2;", setupSQL: "CREATE TABLE orders(order_id INT, customer_id INT, order_date TEXT, total_amount REAL); INSERT INTO orders VALUES (1,1,'2025-01-01',100),(2,2,'2025-01-01',150),(3,1,'2025-01-02',50);" },
                { id: 'eh8', title: 'Inventory Velocity', task: "For each product, calculate the average number of days it sits in inventory before being sold.", tables: ['inventory(product_id, received_date)', 'order_items(product_id, order_date)'], solution: "SELECT 'This is a complex join not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE inventory(product_id INT, received_date TEXT);" },
                { id: 'eh9', title: 'Geographic Sales Analysis', task: "Find the top 3 states with the highest total sales revenue.", tables: ['orders(order_id, total_amount)', 'customers(customer_id, state)', 'orders(customer_id)'], solution: "SELECT c.state, SUM(o.total_amount) as total_revenue FROM customers c JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.state ORDER BY total_revenue DESC LIMIT 3;", setupSQL: "CREATE TABLE customers(customer_id INT, state TEXT); CREATE TABLE orders(customer_id INT, total_amount REAL); INSERT INTO customers VALUES (1, 'CA'),(2,'NY'),(3,'TX'),(4,'CA'); INSERT INTO orders VALUES (1,100),(2,200),(3,150),(4,300),(1,50);" },
                { id: 'eh10', title: 'Time to Second Purchase', task: "For each customer, find the time difference in days between their first and second purchase.", tables: ['orders(customer_id, order_date)'], solution: "WITH RankedOrders AS (SELECT customer_id, order_date, ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date) as rn FROM orders) SELECT r1.customer_id, JULIANDAY(r2.order_date) - JULIANDAY(r1.order_date) FROM RankedOrders r1 JOIN RankedOrders r2 ON r1.customer_id = r2.customer_id WHERE r1.rn = 1 AND r2.rn = 2;", setupSQL: "CREATE TABLE orders(customer_id INT, order_date TEXT); INSERT INTO orders VALUES (1, '2025-01-01'), (1, '2025-01-10'), (2, '2025-02-01');" }
            ];
            // Social Media Questions
            themedQuestionBanks.social.easy = [
                { id: 'soce1', title: 'Find Active Users', task: "Find all users who were last active on or after '2025-08-01'.", tables: ['users(user_id, username, last_active)'], solution: "SELECT * FROM users WHERE last_active >= '2025-08-01';", setupSQL: "CREATE TABLE users(user_id INT, username TEXT, last_active TEXT); INSERT INTO users VALUES (1, 'user_a', '2025-08-10'), (2, 'user_b', '2025-07-20');" },
                { id: 'soce2', title: 'Count Likes per Post', task: "Count the number of likes for each post.", tables: ['likes(like_id, post_id)'], solution: "SELECT post_id, COUNT(like_id) as like_count FROM likes GROUP BY post_id;", setupSQL: "CREATE TABLE likes(like_id INT, post_id INT); INSERT INTO likes VALUES (1, 101), (2, 101), (3, 102);" },
                { id: 'soce3', title: 'Users with No Posts', task: "Find all users who have not created any posts.", tables: ['users(user_id, username)', 'posts(post_id, user_id)'], solution: "SELECT u.username FROM users u LEFT JOIN posts p ON u.user_id = p.user_id WHERE p.post_id IS NULL;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT); CREATE TABLE posts(post_id INT, user_id INT); INSERT INTO users VALUES (1, 'poster'), (2, 'lurker'); INSERT INTO posts VALUES (101, 1);" },
                { id: 'soce4', title: 'Recent Posts', task: "Retrieve all posts created in the last 24 hours (relative to '2025-08-11 12:00:00').", tables: ['posts(post_id, content, created_at)'], solution: "SELECT * FROM posts WHERE created_at >= DATE('2025-08-11 12:00:00', '-1 day');", setupSQL: "CREATE TABLE posts(post_id INT, content TEXT, created_at TEXT); INSERT INTO posts VALUES (1, 'old post', '2025-08-09 10:00:00'), (2, 'new post', '2025-08-11 10:00:00');" },
                { id: 'soce5', title: 'Users from a Specific Country', task: "Find all users from 'Canada'.", tables: ['users(user_id, username, country)'], solution: "SELECT * FROM users WHERE country = 'Canada';", setupSQL: "CREATE TABLE users(user_id INT, username TEXT, country TEXT); INSERT INTO users VALUES (1, 'user_a', 'USA'), (2, 'user_b', 'Canada');" },
                { id: 'soce6', title: 'Count Comments per Post', task: "For each post, count the total number of comments.", tables: ['comments(comment_id, post_id)'], solution: "SELECT post_id, COUNT(comment_id) as comment_count FROM comments GROUP BY post_id;", setupSQL: "CREATE TABLE comments(comment_id INT, post_id INT); INSERT INTO comments VALUES (1, 101), (2, 101), (3, 102);" },
                { id: 'soce7', title: 'Find Verified Users', task: "Select all users who have a 'verified' status.", tables: ['users(user_id, username, is_verified)'], solution: "SELECT * FROM users WHERE is_verified = 1;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT, is_verified INT); INSERT INTO users VALUES (1, 'celeb', 1), (2, 'normie', 0);" },
                { id: 'soce8', title: 'List Unique Post Tags', task: "Get a list of all unique tags used on posts.", tables: ['tags(tag_id, tag_name)'], solution: "SELECT DISTINCT tag_name FROM tags;", setupSQL: "CREATE TABLE tags(tag_id INT, tag_name TEXT); INSERT INTO tags VALUES (1, 'SQL'), (2, 'Data'), (3, 'SQL');" },
                { id: 'soce9', title: 'Find a Specific User by Username', task: "Retrieve all information for the user with the username 'social_user'.", tables: ['users(user_id, username, country)'], solution: "SELECT * FROM users WHERE username = 'social_user';", setupSQL: "CREATE TABLE users(user_id INT, username TEXT, country TEXT); INSERT INTO users VALUES (1, 'another_user', 'USA'), (2, 'social_user', 'Canada');" },
                { id: 'soce10', title: 'Posts by a Specific User', task: "Find all posts created by the user with `user_id` = 1.", tables: ['posts(post_id, user_id, content)'], solution: "SELECT * FROM posts WHERE user_id = 1;", setupSQL: "CREATE TABLE posts(post_id INT, user_id INT, content TEXT); INSERT INTO posts VALUES (101, 1, 'Hello'), (102, 2, 'World'), (103, 1, 'Again');" }
            ];
            themedQuestionBanks.social.medium = [
                { id: 'socm1', title: 'Users Who Liked Their Own Post', task: "Identify users who have liked a post they also created.", tables: ['users(user_id, username)', 'posts(post_id, user_id)', 'likes(like_id, post_id, user_id)'], solution: "SELECT DISTINCT u.username FROM users u JOIN posts p ON u.user_id = p.user_id JOIN likes l ON p.post_id = l.post_id AND u.user_id = l.user_id;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT); CREATE TABLE posts(post_id INT, user_id INT); CREATE TABLE likes(like_id INT, post_id INT, user_id INT); INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO posts VALUES (101, 1), (102, 2); INSERT INTO likes VALUES (1, 101, 1), (2, 101, 2);" },
                { id: 'socm2', title: 'Average Likes per User', task: "Calculate the average number of likes a user's posts receive.", tables: ['posts(post_id, user_id)', 'likes(like_id, post_id)'], solution: "WITH PostLikes AS (SELECT p.user_id, COUNT(l.like_id) as like_count FROM posts p LEFT JOIN likes l ON p.post_id = l.post_id GROUP BY p.post_id) SELECT user_id, AVG(like_count) FROM PostLikes GROUP BY user_id;", setupSQL: "CREATE TABLE posts(post_id INT, user_id INT); CREATE TABLE likes(like_id INT, post_id INT); INSERT INTO posts VALUES (101, 1), (102, 1), (103, 2); INSERT INTO likes VALUES (1,101),(2,101),(3,102),(4,103);" },
                { id: 'socm3', title: 'Second Most Recent Post', task: "For each user, find their second most recent post.", tables: ['posts(post_id, user_id, content, created_at)'], solution: "WITH RankedPosts AS (SELECT user_id, content, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY created_at DESC) as rn FROM posts) SELECT user_id, content FROM RankedPosts WHERE rn = 2;", setupSQL: "CREATE TABLE posts(post_id INT, user_id INT, content TEXT, created_at TEXT); INSERT INTO posts VALUES (1,1,'A','2025-01-01'),(2,1,'B','2025-01-02'),(3,1,'C','2025-01-03');" },
                { id: 'socm4', title: 'Inactive Users (No Activity)', task: "Find users who have not posted, commented, or liked anything in the last year (relative to '2025-08-11').", tables: ['users(user_id, username)', 'posts(user_id, created_at)', 'comments(user_id, created_at)', 'likes(user_id, created_at)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT);" },
                { id: 'socm5', title: 'Groups and Their Member Count', task: "List each group and the number of members in it.", tables: ['groups(group_id, group_name)', 'group_members(group_id, user_id)'], solution: "SELECT g.group_name, COUNT(gm.user_id) FROM groups g JOIN group_members gm ON g.group_id = gm.group_id GROUP BY g.group_name;", setupSQL: "CREATE TABLE groups(group_id INT, group_name TEXT); CREATE TABLE group_members(group_id INT, user_id INT); INSERT INTO groups VALUES (1, 'SQL Fans'), (2, 'Data Nerds'); INSERT INTO group_members VALUES (1,1),(1,2),(2,3);" },
                { id: 'socm6', title: 'Daily New Users', task: "Calculate the number of new users who signed up each day in August 2025.", tables: ['users(user_id, signup_date)'], solution: "SELECT signup_date, COUNT(user_id) FROM users WHERE STRFTIME('%Y-%m', signup_date) = '2025-08' GROUP BY signup_date;", setupSQL: "CREATE TABLE users(user_id INT, signup_date TEXT); INSERT INTO users VALUES (1, '2025-08-01'), (2, '2025-08-01'), (3, '2025-08-02');" },
                { id: 'socm7', title: 'Posts with No Likes', task: "Find all posts that have not received any likes.", tables: ['posts(post_id, content)', 'likes(like_id, post_id)'], solution: "SELECT p.post_id, p.content FROM posts p LEFT JOIN likes l ON p.post_id = l.post_id WHERE l.like_id IS NULL;", setupSQL: "CREATE TABLE posts(post_id INT, content TEXT); CREATE TABLE likes(like_id INT, post_id INT); INSERT INTO posts VALUES (101, 'Liked'), (102, 'Unliked'); INSERT INTO likes VALUES (1, 101);" },
                { id: 'socm8', title: 'User with Most Followers', task: "Find the user who has the most followers.", tables: ['users(user_id, username)', 'followers(user_id, follower_id)'], solution: "SELECT u.username FROM users u JOIN followers f ON u.user_id = f.user_id GROUP BY u.username ORDER BY COUNT(f.follower_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT); CREATE TABLE followers(user_id INT, follower_id INT); INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO followers VALUES (1,10),(1,11),(2,12);" },
                { id: 'socm9', title: 'Average Time to First Like', task: "Calculate the average time (in minutes) between a post's creation and its first like.", tables: ['posts(post_id, created_at)', 'likes(post_id, created_at)'], solution: "WITH FirstLikes AS (SELECT post_id, MIN(created_at) as first_like_time FROM likes GROUP BY post_id) SELECT AVG((JULIANDAY(fl.first_like_time) - JULIANDAY(p.created_at)) * 24 * 60) FROM posts p JOIN FirstLikes fl ON p.post_id = fl.post_id;", setupSQL: "CREATE TABLE posts(post_id INT, created_at TEXT); CREATE TABLE likes(post_id INT, created_at TEXT); INSERT INTO posts VALUES (101, '2025-08-01 10:00:00'); INSERT INTO likes VALUES (101, '2025-08-01 10:05:00');" },
                { id: 'socm10', title: 'Follower/Following Ratio', task: "For each user, calculate their follower-to-following ratio.", tables: ['followers(user_id, follower_id)', 'following(user_id, following_id)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE followers(user_id INT, follower_id INT);" }
            ];
            themedQuestionBanks.social.hard = [
                { id: 'soch1', title: 'Influencer Identification', task: "Identify 'Influencers' who have more than 10,000 followers and an average of over 1,000 likes per post.", tables: ['users(user_id, username)', 'followers(user_id, follower_id)', 'posts(post_id, user_id)', 'likes(like_id, post_id)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE users(user_id INT, username TEXT);" },
                { id: 'soch2', title: 'Engagement Funnel', task: "For each user, calculate the ratio of posts they've liked to the total number of posts they've seen.", tables: ['post_views(user_id, post_id)', 'likes(user_id, post_id)'], solution: "WITH UserViews AS (SELECT user_id, COUNT(post_id) as views FROM post_views GROUP BY user_id), UserLikes AS (SELECT user_id, COUNT(post_id) as likes FROM likes GROUP BY user_id) SELECT uv.user_id, CAST(ul.likes AS REAL) / uv.views FROM UserViews uv JOIN UserLikes ul ON uv.user_id = ul.user_id;", setupSQL: "CREATE TABLE post_views(user_id INT, post_id INT); CREATE TABLE likes(user_id INT, post_id INT); INSERT INTO post_views VALUES (1,101),(1,102),(1,103),(1,104); INSERT INTO likes VALUES (1,101),(1,102);" },
                { id: 'soch3', title: 'Running Total of Daily Posts', task: "Calculate the running total of posts created each day.", tables: ['posts(post_id, created_at)'], solution: "WITH DailyPosts AS (SELECT CAST(created_at AS DATE) as post_date, COUNT(post_id) as daily_posts FROM posts GROUP BY post_date) SELECT post_date, SUM(daily_posts) OVER (ORDER BY post_date) FROM DailyPosts;", setupSQL: "CREATE TABLE posts(post_id INT, created_at TEXT); INSERT INTO posts VALUES (1, '2025-08-01'),(2, '2025-08-01'),(3, '2025-08-02');" },
                { id: 'soch4', title: 'Consecutive Day Posting Streak', task: "Find all users who have created a post on 5 or more consecutive days.", tables: ['posts(user_id, created_at)'], solution: "WITH DailyPosts AS (SELECT DISTINCT user_id, CAST(created_at AS DATE) as post_day FROM posts), Grouped AS (SELECT user_id, post_day, DATE(post_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY post_day)) || ' days') as streak_group FROM DailyPosts) SELECT user_id, COUNT(*) as streak_length FROM Grouped GROUP BY user_id, streak_group HAVING COUNT(*) >= 5;", setupSQL: "CREATE TABLE posts(user_id INT, created_at TEXT); INSERT INTO posts VALUES (1,'2025-01-01'),(1,'2025-01-02'),(1,'2025-01-03'),(1,'2025-01-04'),(1,'2025-01-05');" },
                { id: 'soch5', title: 'Most Engaging Content', task: "Find the post with the highest number of comments and likes combined.", tables: ['posts(post_id)', 'likes(post_id)', 'comments(post_id)'], solution: "WITH Engagement AS (SELECT post_id, COUNT(*) as interactions FROM likes GROUP BY post_id UNION ALL SELECT post_id, COUNT(*) FROM comments GROUP BY post_id) SELECT post_id, SUM(interactions) FROM Engagement GROUP BY post_id ORDER BY SUM(interactions) DESC LIMIT 1;", setupSQL: "CREATE TABLE posts(post_id INT); CREATE TABLE likes(post_id INT); CREATE TABLE comments(post_id INT); INSERT INTO posts VALUES (101),(102); INSERT INTO likes VALUES (101),(101),(102); INSERT INTO comments VALUES (101),(102);" },
                { id: 'soch6', title: 'User Cohort Engagement', task: "For users who joined in Jan 2025, what was their average number of posts in Feb 2025?", tables: ['users(user_id, signup_date)', 'posts(user_id, created_at)'], solution: "WITH JanCohort AS (SELECT user_id FROM users WHERE STRFTIME('%Y-%m', signup_date) = '2025-01'), FebPosts AS (SELECT user_id, COUNT(post_id) as post_count FROM posts WHERE STRFTIME('%Y-%m', created_at) = '2025-02' GROUP BY user_id) SELECT AVG(fp.post_count) FROM JanCohort jc LEFT JOIN FebPosts fp ON jc.user_id = fp.user_id;", setupSQL: "CREATE TABLE users(user_id INT, signup_date TEXT); CREATE TABLE posts(user_id INT, post_id INT, created_at TEXT); INSERT INTO users VALUES (1, '2025-01-10'),(2, '2025-01-15'); INSERT INTO posts VALUES (1, 101, '2025-02-05'),(1, 102, '2025-02-06');" },
                { id: 'soch7', title: 'Viral Posts', task: "Identify posts that received more than 1000 likes within the first hour of being posted.", tables: ['posts(post_id, created_at)', 'likes(post_id, created_at)'], solution: "WITH ViralCheck AS (SELECT p.post_id, COUNT(l.like_id) as like_count FROM posts p JOIN likes l ON p.post_id = l.post_id WHERE JULIANDAY(l.created_at) - JULIANDAY(p.created_at) < 1.0/24 GROUP BY p.post_id) SELECT post_id FROM ViralCheck WHERE like_count > 1000;", setupSQL: "CREATE TABLE posts(post_id INT, created_at TEXT); CREATE TABLE likes(like_id INT, post_id INT, created_at TEXT);" },
                { id: 'soch8', title: 'Mutual Friends', task: "Find all pairs of users who are mutual friends.", tables: ['friends(user_id, friend_id)'], solution: "SELECT f1.user_id, f1.friend_id FROM friends f1 JOIN friends f2 ON f1.user_id = f2.friend_id AND f1.friend_id = f2.user_id WHERE f1.user_id < f1.friend_id;", setupSQL: "CREATE TABLE friends(user_id INT, friend_id INT); INSERT INTO friends VALUES (1, 2), (2, 1), (1, 3);" },
                { id: 'soch9', title: 'Content Recommendation (Collaborative Filtering)', task: "Suggest posts to a user that have been liked by other users who also liked what the current user liked.", tables: ['likes(user_id, post_id)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE likes(user_id INT, post_id INT);" },
                { id: 'soch10', title: 'Time Between Posts', task: "For each user, calculate the average time difference in hours between their consecutive posts.", tables: ['posts(user_id, created_at)'], solution: "WITH DatedPosts AS (SELECT user_id, created_at, LAG(created_at, 1) OVER (PARTITION BY user_id ORDER BY created_at) as prev_post_time FROM posts) SELECT user_id, AVG((JULIANDAY(created_at) - JULIANDAY(prev_post_time)) * 24) FROM DatedPosts WHERE prev_post_time IS NOT NULL GROUP BY user_id;", setupSQL: "CREATE TABLE posts(user_id INT, created_at TEXT); INSERT INTO posts VALUES (1, '2025-08-01 10:00:00'), (1, '2025-08-01 12:00:00');" }
            ];       

            // Fintech Questions
            themedQuestionBanks.fintech.easy = [
                { id: 'fte1', title: 'Find Large Transactions', task: "Find all transactions greater than $1000.", tables: ['transactions(txn_id, amount, currency)'], solution: "SELECT * FROM transactions WHERE amount > 1000;", setupSQL: "CREATE TABLE transactions(txn_id INT, amount REAL, currency TEXT); INSERT INTO transactions VALUES (1, 500.0, 'USD'), (2, 1200.0, 'USD'), (3, 950.0, 'EUR');" },
                { id: 'fte2', title: 'Count Accounts by Type', task: "Count the number of accounts for each `account_type`.", tables: ['accounts(account_id, user_id, account_type)'], solution: "SELECT account_type, COUNT(account_id) FROM accounts GROUP BY account_type;", setupSQL: "CREATE TABLE accounts(account_id INT, user_id INT, account_type TEXT); INSERT INTO accounts VALUES (1, 1, 'checking'), (2, 1, 'savings'), (3, 2, 'checking');" },
                { id: 'fte3', title: 'Users with No Transactions', task: "Find all users who have not made any transactions.", tables: ['users(user_id, name)', 'transactions(txn_id, user_id)'], solution: "SELECT u.name FROM users u LEFT JOIN transactions t ON u.user_id = t.user_id WHERE t.txn_id IS NULL;", setupSQL: "CREATE TABLE users(user_id INT, name TEXT); CREATE TABLE transactions(txn_id INT, user_id INT); INSERT INTO users VALUES (1, 'Active User'), (2, 'New User'); INSERT INTO transactions VALUES (101, 1);" },
                { id: 'fte4', title: 'Recent Transactions', task: "Retrieve all transactions that occurred on or after '2025-08-01'.", tables: ['transactions(txn_id, amount, txn_date)'], solution: "SELECT * FROM transactions WHERE txn_date >= '2025-08-01';", setupSQL: "CREATE TABLE transactions(txn_id INT, amount REAL, txn_date TEXT); INSERT INTO transactions VALUES (1, 100, '2025-07-31'), (2, 200, '2025-08-01');" },
                { id: 'fte5', title: 'Users from a Specific Country', task: "Find all users with a registered address in 'USA'.", tables: ['users(user_id, name, country)'], solution: "SELECT * FROM users WHERE country = 'USA';", setupSQL: "CREATE TABLE users(user_id INT, name TEXT, country TEXT); INSERT INTO users VALUES (1, 'John', 'USA'), (2, 'Jane', 'Canada');" },
                { id: 'fte6', title: 'Count Transactions per User', task: "For each user, count their total number of transactions.", tables: ['transactions(txn_id, user_id)'], solution: "SELECT user_id, COUNT(txn_id) FROM transactions GROUP BY user_id;", setupSQL: "CREATE TABLE transactions(txn_id INT, user_id INT); INSERT INTO transactions VALUES (1, 1), (2, 1), (3, 2);" },
                { id: 'fte7', title: 'Find Flagged Transactions', task: "Select all transactions that have been flagged for review (`is_flagged` = 1).", tables: ['transactions(txn_id, amount, is_flagged)'], solution: "SELECT * FROM transactions WHERE is_flagged = 1;", setupSQL: "CREATE TABLE transactions(txn_id INT, amount REAL, is_flagged INT); INSERT INTO transactions VALUES (1, 100, 0), (2, 5000, 1);" },
                { id: 'fte8', title: 'List Unique Currencies', task: "Get a list of all unique currencies used in transactions.", tables: ['transactions(txn_id, currency)'], solution: "SELECT DISTINCT currency FROM transactions;", setupSQL: "CREATE TABLE transactions(txn_id INT, currency TEXT); INSERT INTO transactions VALUES (1, 'USD'), (2, 'EUR'), (3, 'USD');" },
                { id: 'fte9', title: 'Find a Specific Account', task: "Retrieve all information for the account with `account_id` = 12345.", tables: ['accounts(account_id, user_id, balance)'], solution: "SELECT * FROM accounts WHERE account_id = 12345;", setupSQL: "CREATE TABLE accounts(account_id INT, user_id INT, balance REAL); INSERT INTO accounts VALUES (12345, 1, 5000.0), (67890, 2, 10000.0);" },
                { id: 'fte10', title: 'Transactions by a Specific Merchant', task: "Find all transactions at the merchant 'Starbucks'.", tables: ['transactions(txn_id, amount, merchant)'], solution: "SELECT * FROM transactions WHERE merchant = 'Starbucks';", setupSQL: "CREATE TABLE transactions(txn_id INT, amount REAL, merchant TEXT); INSERT INTO transactions VALUES (1, 5.50, 'Starbucks'), (2, 50.0, 'Amazon');" }
            ];
            themedQuestionBanks.fintech.medium = [
                { id: 'ftm1', title: 'Users with Multiple Account Types', task: "Identify users who have both a 'checking' and a 'savings' account.", tables: ['accounts(user_id, account_type)'], solution: "SELECT user_id FROM accounts WHERE account_type IN ('checking', 'savings') GROUP BY user_id HAVING COUNT(DISTINCT account_type) = 2;", setupSQL: "CREATE TABLE accounts(user_id INT, account_type TEXT); INSERT INTO accounts VALUES (1, 'checking'), (1, 'savings'), (2, 'checking');" },
                { id: 'ftm2', title: 'Average Transaction Amount', task: "Calculate the average amount for all 'completed' transactions.", tables: ['transactions(txn_id, amount, status)'], solution: "SELECT AVG(amount) FROM transactions WHERE status = 'completed';", setupSQL: "CREATE TABLE transactions(txn_id INT, amount REAL, status TEXT); INSERT INTO transactions VALUES (1, 100, 'completed'), (2, 200, 'pending'), (3, 300, 'completed');" },
                { id: 'ftm3', title: 'Second Most Recent Transaction', task: "For each user, find their second most recent transaction amount.", tables: ['transactions(user_id, amount, txn_date)'], solution: "WITH RankedTxns AS (SELECT user_id, amount, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY txn_date DESC) as rn FROM transactions) SELECT user_id, amount FROM RankedTxns WHERE rn = 2;", setupSQL: "CREATE TABLE transactions(user_id INT, amount REAL, txn_date TEXT); INSERT INTO transactions VALUES (1, 10, '2025-01-01'), (1, 20, '2025-01-02'), (1, 30, '2025-01-03');" },
                { id: 'ftm4', title: 'Dormant Accounts', task: "Find accounts that have had no transaction activity in the last 6 months (relative to '2025-08-11').", tables: ['accounts(account_id)', 'transactions(account_id, txn_date)'], solution: "SELECT a.account_id FROM accounts a LEFT JOIN transactions t ON a.account_id = t.account_id GROUP BY a.account_id HAVING MAX(t.txn_date) < DATE('2025-08-11', '-6 months') OR MAX(t.txn_date) IS NULL;", setupSQL: "CREATE TABLE accounts(account_id INT); CREATE TABLE transactions(account_id INT, txn_date TEXT); INSERT INTO accounts VALUES (1), (2); INSERT INTO transactions VALUES (1, '2025-08-01'), (2, '2025-01-01');" },
                { id: 'ftm5', title: 'Merchants and Their Transaction Count', task: "List each merchant and the number of transactions they've processed.", tables: ['transactions(txn_id, merchant)'], solution: "SELECT merchant, COUNT(txn_id) FROM transactions GROUP BY merchant;", setupSQL: "CREATE TABLE transactions(txn_id INT, merchant TEXT); INSERT INTO transactions VALUES (1, 'Amazon'), (2, 'Starbucks'), (3, 'Amazon');" },
                { id: 'ftm6', title: 'Monthly Transaction Volume', task: "Calculate the total transaction volume (sum of amounts) for each month in 2025.", tables: ['transactions(amount, txn_date)'], solution: "SELECT STRFTIME('%Y-%m', txn_date) as month, SUM(amount) FROM transactions WHERE STRFTIME('%Y', txn_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE transactions(amount REAL, txn_date TEXT); INSERT INTO transactions VALUES (100, '2025-01-10'), (200, '2025-01-15'), (300, '2025-02-05');" },
                { id: 'ftm7', title: 'Users Who Only Transact in USD', task: "Find all users who have only ever made transactions in 'USD'.", tables: ['transactions(user_id, currency)'], solution: "SELECT user_id FROM transactions GROUP BY user_id HAVING COUNT(DISTINCT currency) = 1 AND MAX(currency) = 'USD';", setupSQL: "CREATE TABLE transactions(user_id INT, currency TEXT); INSERT INTO transactions VALUES (1, 'USD'), (2, 'USD'), (2, 'EUR'), (3, 'USD');" },
                { id: 'ftm8', title: 'User with Highest Single Transaction', task: "Find the user who made the single largest transaction.", tables: ['users(user_id, name)', 'transactions(user_id, amount)'], solution: "SELECT u.name FROM users u JOIN transactions t ON u.user_id = t.user_id ORDER BY t.amount DESC LIMIT 1;", setupSQL: "CREATE TABLE users(user_id INT, name TEXT); CREATE TABLE transactions(user_id INT, amount REAL); INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO transactions VALUES (1, 1000), (2, 5000);" },
                { id: 'ftm9', title: 'Average Time Between Transactions', task: "Calculate the average time (in days) between a user's subsequent transactions.", tables: ['transactions(user_id, txn_date)'], solution: "WITH DatedTxns AS (SELECT user_id, txn_date, LAG(txn_date, 1) OVER (PARTITION BY user_id ORDER BY txn_date) as prev_date FROM transactions) SELECT AVG(JULIANDAY(txn_date) - JULIANDAY(prev_date)) FROM DatedTxns WHERE prev_date IS NOT NULL;", setupSQL: "CREATE TABLE transactions(user_id INT, txn_date TEXT); INSERT INTO transactions VALUES (1, '2025-01-01'), (1, '2025-01-11');" },
                { id: 'ftm10', title: 'Transaction Status Breakdown', task: "Count the number of transactions for each status (e.g., pending, completed, failed).", tables: ['transactions(txn_id, status)'], solution: "SELECT status, COUNT(txn_id) FROM transactions GROUP BY status;", setupSQL: "CREATE TABLE transactions(txn_id INT, status TEXT); INSERT INTO transactions VALUES (1, 'completed'), (2, 'pending'), (3, 'completed');" }
            ];
            themedQuestionBanks.fintech.hard = [
                { id: 'fth1', title: 'High-Frequency Traders', task: "Identify users who have made more than 100 transactions in the past month with a total volume over $50,000.", tables: ['users(user_id, name)', 'transactions(user_id, amount, txn_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE users(user_id INT, name TEXT);" },
                { id: 'fth2', title: 'Fraud Detection (Abnormal Spending)', task: "Find users whose transaction amount on a given day is more than 5 times their daily average over the last 30 days.", tables: ['transactions(user_id, amount, txn_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE transactions(user_id INT, amount REAL, txn_date TEXT);" },
                { id: 'fth3', title: 'Running Balance', task: "For a specific user account, calculate the running balance after each transaction.", tables: ['transactions(account_id, amount, type, txn_date)'], solution: "SELECT txn_date, amount, type, SUM(CASE WHEN type = 'credit' THEN amount ELSE -amount END) OVER (PARTITION BY account_id ORDER BY txn_date) as running_balance FROM transactions WHERE account_id = 123;", setupSQL: "CREATE TABLE transactions(account_id INT, amount REAL, type TEXT, txn_date TEXT); INSERT INTO transactions VALUES (123, 1000, 'credit', '2025-01-01'), (123, 50, 'debit', '2025-01-02');" },
                { id: 'fth4', title: 'Consecutive Day Trading', task: "Find all users who have made a transaction on 5 or more consecutive days.", tables: ['transactions(user_id, txn_date)'], solution: "WITH DailyTxns AS (SELECT DISTINCT user_id, CAST(txn_date AS DATE) as trade_day FROM transactions), Grouped AS (SELECT user_id, trade_day, DATE(trade_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY trade_day)) || ' days') as streak_group FROM DailyTxns) SELECT user_id, COUNT(*) as streak_length FROM Grouped GROUP BY user_id, streak_group HAVING COUNT(*) >= 5;", setupSQL: "CREATE TABLE transactions(user_id INT, txn_date TEXT); INSERT INTO transactions VALUES (1,'2025-01-01'),(1,'2025-01-02'),(1,'2025-01-03'),(1,'2025-01-04'),(1,'2025-01-05');" },
                { id: 'fth5', title: 'Most Frequent Transaction Pair', task: "Find the pair of merchants a user most frequently transacts with sequentially.", tables: ['transactions(user_id, merchant, txn_date)'], solution: "WITH SequencedTxns AS (SELECT user_id, merchant, LEAD(merchant, 1) OVER (PARTITION BY user_id ORDER BY txn_date) as next_merchant FROM transactions) SELECT merchant, next_merchant, COUNT(*) FROM SequencedTxns WHERE next_merchant IS NOT NULL GROUP BY 1, 2 ORDER BY 3 DESC LIMIT 1;", setupSQL: "CREATE TABLE transactions(user_id INT, merchant TEXT, txn_date TEXT); INSERT INTO transactions VALUES (1, 'A', '2025-01-01'),(1, 'B', '2025-01-02'),(1, 'A', '2025-01-03'),(1, 'B', '2025-01-04');" },
                { id: 'fth6', title: 'New User Activation Rate', task: "For users who signed up in Jan 2025, what percentage made their first transaction within 7 days?", tables: ['users(user_id, signup_date)', 'transactions(user_id, txn_date)'], solution: "WITH JanCohort AS (SELECT user_id FROM users WHERE STRFTIME('%Y-%m', signup_date) = '2025-01'), FirstTxn AS (SELECT user_id, MIN(txn_date) as first_txn_date FROM transactions GROUP BY user_id) SELECT CAST(COUNT(jc.user_id) AS REAL) * 100 / (SELECT COUNT(*) FROM JanCohort) FROM JanCohort jc JOIN FirstTxn ft ON jc.user_id = ft.user_id JOIN users u ON jc.user_id = u.user_id WHERE JULIANDAY(ft.first_txn_date) - JULIANDAY(u.signup_date) <= 7;", setupSQL: "CREATE TABLE users(user_id INT, signup_date TEXT); CREATE TABLE transactions(user_id INT, txn_date TEXT); INSERT INTO users VALUES (1, '2025-01-01'), (2, '2025-01-10'); INSERT INTO transactions VALUES (1, '2025-01-05');" },
                { id: 'fth7', title: 'Velocity Check (Fraud)', task: "Identify users who have made transactions in two different countries within a 1-hour window.", tables: ['transactions(user_id, country, txn_date)'], solution: "WITH DatedTxns AS (SELECT user_id, country, txn_date, LAG(txn_date, 1) OVER (PARTITION BY user_id ORDER BY txn_date) as prev_txn_date, LAG(country, 1) OVER (PARTITION BY user_id ORDER BY txn_date) as prev_country FROM transactions) SELECT DISTINCT user_id FROM DatedTxns WHERE country != prev_country AND (JULIANDAY(txn_date) - JULIANDAY(prev_txn_date)) * 24 < 1;", setupSQL: "CREATE TABLE transactions(user_id INT, country TEXT, txn_date TEXT); INSERT INTO transactions VALUES (1, 'USA', '2025-08-01 10:00:00'), (1, 'CAN', '2025-08-01 10:30:00');" },
                { id: 'fth8', title: 'Portfolio Diversification', task: "For each user, calculate the number of different stock symbols they have traded.", tables: ['trades(user_id, stock_symbol)'], solution: "SELECT user_id, COUNT(DISTINCT stock_symbol) FROM trades GROUP BY user_id;", setupSQL: "CREATE TABLE trades(user_id INT, stock_symbol TEXT); INSERT INTO trades VALUES (1, 'AAPL'), (1, 'GOOG'), (2, 'MSFT');" },
                { id: 'fth9', title: 'Geographic Transaction Hotspots', task: "Find the top 3 cities with the highest total transaction volume.", tables: ['transactions(amount, city)'], solution: "SELECT city, SUM(amount) FROM transactions GROUP BY city ORDER BY 2 DESC LIMIT 3;", setupSQL: "CREATE TABLE transactions(amount REAL, city TEXT); INSERT INTO transactions VALUES (100, 'NY'),(200,'SF'),(150,'NY'),(300,'LA'),(50,'SF');" },
                { id: 'fth10', title: 'Time to First Transaction', task: "For each user, find the time difference in days between their sign-up date and their first transaction.", tables: ['users(user_id, signup_date)', 'transactions(user_id, txn_date)'], solution: "WITH FirstTxn AS (SELECT user_id, MIN(txn_date) as first_txn FROM transactions GROUP BY user_id) SELECT u.user_id, JULIANDAY(ft.first_txn) - JULIANDAY(u.signup_date) FROM users u JOIN FirstTxn ft ON u.user_id = ft.user_id;", setupSQL: "CREATE TABLE users(user_id INT, signup_date TEXT); CREATE TABLE transactions(user_id INT, txn_date TEXT); INSERT INTO users VALUES (1, '2025-01-01'); INSERT INTO transactions VALUES (1, '2025-01-05');" }
            ];

            // Healthcare Questions
            themedQuestionBanks.healthcare.easy = [
                { id: 'hce1', title: 'Find Patients for a Doctor', task: "Find all patients assigned to Dr. Smith (`doctor_id` = 2).", tables: ['patients(patient_id, name, primary_doctor_id)'], solution: "SELECT * FROM patients WHERE primary_doctor_id = 2;", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT, primary_doctor_id INT); INSERT INTO patients VALUES (101, 'John Doe', 1), (102, 'Jane Ray', 2), (103, 'Peter Pan', 2);" },
                { id: 'hce2', title: 'Count Appointments by Status', task: "Count the number of appointments for each `status` (e.g., Scheduled, Completed, Canceled).", tables: ['appointments(appt_id, patient_id, status)'], solution: "SELECT status, COUNT(appt_id) FROM appointments GROUP BY status;", setupSQL: "CREATE TABLE appointments(appt_id INT, patient_id INT, status TEXT); INSERT INTO appointments VALUES (1, 101, 'Completed'), (2, 102, 'Scheduled'), (3, 103, 'Completed');" },
                { id: 'hce3', title: 'Patients with No Appointments', task: "Find all patients who have never scheduled an appointment.", tables: ['patients(patient_id, name)', 'appointments(appt_id, patient_id)'], solution: "SELECT p.name FROM patients p LEFT JOIN appointments a ON p.patient_id = a.patient_id WHERE a.appt_id IS NULL;", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT); CREATE TABLE appointments(appt_id INT, patient_id INT); INSERT INTO patients VALUES (1, 'Patient A'), (2, 'Patient B'); INSERT INTO appointments VALUES (101, 1);" },
                { id: 'hce4', title: 'Recent Lab Results', task: "Retrieve all lab results that were recorded on or after '2025-08-01'.", tables: ['lab_results(result_id, patient_id, result_date)'], solution: "SELECT * FROM lab_results WHERE result_date >= '2025-08-01';", setupSQL: "CREATE TABLE lab_results(result_id INT, patient_id INT, result_date TEXT); INSERT INTO lab_results VALUES (1, 1, '2025-07-30'), (2, 1, '2025-08-02');" },
                { id: 'hce5', title: 'Patients from a Specific City', task: "Find all patients who live in 'San Francisco'.", tables: ['patients(patient_id, name, city)'], solution: "SELECT * FROM patients WHERE city = 'San Francisco';", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT, city TEXT); INSERT INTO patients VALUES (1, 'John', 'Boston'), (2, 'Jane', 'San Francisco');" },
                { id: 'hce6', title: 'Count Claims per Patient', task: "For each patient, count their total number of insurance claims.", tables: ['claims(claim_id, patient_id)'], solution: "SELECT patient_id, COUNT(claim_id) FROM claims GROUP BY patient_id;", setupSQL: "CREATE TABLE claims(claim_id INT, patient_id INT); INSERT INTO claims VALUES (1, 101), (2, 101), (3, 102);" },
                { id: 'hce7', title: 'Find High-Urgency Visits', task: "Select all emergency room visits (`visit_type` = 'ER').", tables: ['visits(visit_id, patient_id, visit_type)'], solution: "SELECT * FROM visits WHERE visit_type = 'ER';", setupSQL: "CREATE TABLE visits(visit_id INT, patient_id INT, visit_type TEXT); INSERT INTO visits VALUES (1, 1, 'Check-up'), (2, 2, 'ER');" },
                { id: 'hce8', title: 'List Unique Insurance Providers', task: "Get a list of all unique insurance providers.", tables: ['insurance(plan_id, provider_name)'], solution: "SELECT DISTINCT provider_name FROM insurance;", setupSQL: "CREATE TABLE insurance(plan_id INT, provider_name TEXT); INSERT INTO insurance VALUES (1, 'Blue Cross'), (2, 'Aetna'), (3, 'Blue Cross');" },
                { id: 'hce9', title: 'Find a Specific Patient Record', task: "Retrieve all information for the patient with `patient_id` = 123.", tables: ['patients(patient_id, name, dob)'], solution: "SELECT * FROM patients WHERE patient_id = 123;", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT, dob TEXT); INSERT INTO patients VALUES (123, 'John Doe', '1980-01-01'), (456, 'Jane Smith', '1990-02-02');" },
                { id: 'hce10', title: 'Prescriptions for a Patient', task: "Find all prescriptions for the patient with `patient_id` = 123.", tables: ['prescriptions(rx_id, patient_id, medication)'], solution: "SELECT * FROM prescriptions WHERE patient_id = 123;", setupSQL: "CREATE TABLE prescriptions(rx_id INT, patient_id INT, medication TEXT); INSERT INTO prescriptions VALUES (1, 123, 'Meda'), (2, 456, 'Medb'), (3, 123, 'Medc');" }
            ];
            themedQuestionBanks.healthcare.medium = [
                { id: 'hcm1', title: 'Patients with Multiple Conditions', task: "Identify patients who have been diagnosed with both 'Diabetes' and 'Hypertension'.", tables: ['diagnoses(patient_id, condition)'], solution: "SELECT patient_id FROM diagnoses WHERE condition IN ('Diabetes', 'Hypertension') GROUP BY patient_id HAVING COUNT(DISTINCT condition) = 2;", setupSQL: "CREATE TABLE diagnoses(patient_id INT, condition TEXT); INSERT INTO diagnoses VALUES (1, 'Diabetes'), (1, 'Hypertension'), (2, 'Diabetes');" },
                { id: 'hcm2', title: 'Average Length of Stay', task: "Calculate the average length of stay (in days) for all hospital admissions.", tables: ['admissions(admission_id, admission_date, discharge_date)'], solution: "SELECT AVG(JULIANDAY(discharge_date) - JULIANDAY(admission_date)) FROM admissions;", setupSQL: "CREATE TABLE admissions(admission_id INT, admission_date TEXT, discharge_date TEXT); INSERT INTO admissions VALUES (1, '2025-01-01', '2025-01-05'), (2, '2025-02-01', '2025-02-11');" },
                { id: 'hcm3', title: 'Second Most Recent Visit', task: "For each patient, find their second most recent doctor's visit date.", tables: ['visits(visit_id, patient_id, visit_date)'], solution: "WITH RankedVisits AS (SELECT patient_id, visit_date, ROW_NUMBER() OVER(PARTITION BY patient_id ORDER BY visit_date DESC) as rn FROM visits) SELECT patient_id, visit_date FROM RankedVisits WHERE rn = 2;", setupSQL: "CREATE TABLE visits(visit_id INT, patient_id INT, visit_date TEXT); INSERT INTO visits VALUES (1,1,'2025-01-01'),(2,1,'2025-02-02'),(3,1,'2025-03-03');" },
                { id: 'hcm4', title: 'Lapsed Patients', task: "Find patients who have not had an appointment in over a year (relative to '2025-08-11').", tables: ['patients(patient_id, name)', 'appointments(appt_id, patient_id, appt_date)'], solution: "SELECT p.name FROM patients p LEFT JOIN appointments a ON p.patient_id = a.patient_id GROUP BY p.name HAVING MAX(a.appt_date) < DATE('2025-08-11', '-1 year');", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT); CREATE TABLE appointments(appt_id INT, patient_id INT, appt_date TEXT); INSERT INTO patients VALUES (1, 'Recent'), (2, 'Lapsed'); INSERT INTO appointments VALUES (1,1,'2025-07-15'),(2,2,'2024-01-10');" },
                { id: 'hcm5', title: 'Doctors and Their Patient Count', task: "List each doctor and the number of unique patients they have seen.", tables: ['doctors(doctor_id, name)', 'visits(doctor_id, patient_id)'], solution: "SELECT d.name, COUNT(DISTINCT v.patient_id) FROM doctors d JOIN visits v ON d.doctor_id = v.doctor_id GROUP BY d.name;", setupSQL: "CREATE TABLE doctors(doctor_id INT, name TEXT); CREATE TABLE visits(doctor_id INT, patient_id INT); INSERT INTO doctors VALUES (1, 'Dr. Smith'), (2, 'Dr. Jones'); INSERT INTO visits VALUES (1,101),(1,102),(2,101);" },
                { id: 'hcm6', title: 'Monthly Admissions', task: "Calculate the total number of hospital admissions for each month in 2025.", tables: ['admissions(admission_id, admission_date)'], solution: "SELECT STRFTIME('%Y-%m', admission_date) as month, COUNT(admission_id) FROM admissions WHERE STRFTIME('%Y', admission_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE admissions(admission_id INT, admission_date TEXT); INSERT INTO admissions VALUES (1, '2025-01-10'), (2, '2025-01-15'), (3, '2025-02-05');" },
                { id: 'hcm7', title: 'Patients Without Insurance', task: "Find all patients who do not have an associated insurance plan.", tables: ['patients(patient_id, name)', 'insurance_plans(plan_id, patient_id)'], solution: "SELECT p.name FROM patients p LEFT JOIN insurance_plans ip ON p.patient_id = ip.patient_id WHERE ip.plan_id IS NULL;", setupSQL: "CREATE TABLE patients(patient_id INT, name TEXT); CREATE TABLE insurance_plans(plan_id INT, patient_id INT); INSERT INTO patients VALUES (1, 'Insured'), (2, 'Uninsured'); INSERT INTO insurance_plans VALUES (101, 1);" },
                { id: 'hcm8', title: 'Doctor with Most Appointments', task: "Find the doctor who has had the most appointments.", tables: ['doctors(doctor_id, name)', 'appointments(appt_id, doctor_id)'], solution: "SELECT d.name FROM doctors d JOIN appointments a ON d.doctor_id = a.doctor_id GROUP BY d.name ORDER BY COUNT(a.appt_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE doctors(doctor_id INT, name TEXT); CREATE TABLE appointments(appt_id INT, doctor_id INT); INSERT INTO doctors VALUES (1, 'Dr. Smith'), (2, 'Dr. Jones'); INSERT INTO appointments VALUES (1,1),(2,1),(3,2);" },
                { id: 'hcm9', title: 'Average Time to Fill Prescription', task: "Calculate the average time (in hours) between a prescription being written and it being filled.", tables: ['prescriptions(rx_id, written_date, filled_date)'], solution: "SELECT AVG((JULIANDAY(filled_date) - JULIANDAY(written_date)) * 24) FROM prescriptions WHERE filled_date IS NOT NULL;", setupSQL: "CREATE TABLE prescriptions(rx_id INT, written_date TEXT, filled_date TEXT); INSERT INTO prescriptions VALUES (1, '2025-08-01 10:00:00', '2025-08-01 14:00:00');" },
                { id: 'hcm10', title: 'Appointment No-Show Rate', task: "Calculate the percentage of scheduled appointments that were marked as 'No-Show'.", tables: ['appointments(appt_id, status)'], solution: "SELECT CAST(SUM(CASE WHEN status = 'No-Show' THEN 1 ELSE 0 END) AS REAL) * 100 / COUNT(appt_id) FROM appointments;", setupSQL: "CREATE TABLE appointments(appt_id INT, status TEXT); INSERT INTO appointments VALUES (1, 'Completed'), (2, 'No-Show'), (3, 'Completed'), (4, 'Scheduled');" }
            ];
            themedQuestionBanks.healthcare.hard = [
                { id: 'hch1', title: 'High-Risk Patients', task: "Identify patients who are over 65, have more than 2 chronic conditions, and have been admitted to the hospital more than once in the last year.", tables: ['patients(patient_id, dob)', 'diagnoses(patient_id, condition)', 'admissions(patient_id, admission_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE patients(patient_id INT, dob TEXT);" },
                { id: 'hch2', title: 'Readmission Rate', task: "Calculate the 30-day hospital readmission rate.", tables: ['admissions(patient_id, admission_date, discharge_date)'], solution: "WITH DatedAdmissions AS (SELECT patient_id, admission_date, LAG(discharge_date, 1) OVER (PARTITION BY patient_id ORDER BY admission_date) as prev_discharge FROM admissions) SELECT CAST(SUM(CASE WHEN JULIANDAY(admission_date) - JULIANDAY(prev_discharge) <= 30 THEN 1 ELSE 0 END) AS REAL) * 100 / COUNT(prev_discharge) FROM DatedAdmissions WHERE prev_discharge IS NOT NULL;", setupSQL: "CREATE TABLE admissions(patient_id INT, admission_date TEXT, discharge_date TEXT); INSERT INTO admissions VALUES (1, '2025-01-01', '2025-01-05'), (1, '2025-01-25', '2025-01-30'), (2, '2025-02-01', '2025-02-10');" },
                { id: 'hch3', title: 'Patient Treatment Journey', task: "For patients with a specific diagnosis, list all procedures they underwent in chronological order.", tables: ['diagnoses(patient_id, condition)', 'procedures(patient_id, procedure_name, procedure_date)'], solution: "SELECT p.procedure_name, p.procedure_date FROM procedures p JOIN diagnoses d ON p.patient_id = d.patient_id WHERE d.condition = 'Heart Disease' ORDER BY p.procedure_date;", setupSQL: "CREATE TABLE diagnoses(patient_id INT, condition TEXT); CREATE TABLE procedures(patient_id INT, procedure_name TEXT, procedure_date TEXT); INSERT INTO diagnoses VALUES (1, 'Heart Disease'); INSERT INTO procedures VALUES (1, 'Angioplasty', '2025-02-01'), (1, 'Stent Placement', '2025-03-01');" },
                { id: 'hch4', title: 'Consecutive Day Vitals', task: "Find all patients who had their vitals (e.g., blood pressure) recorded on 7 or more consecutive days.", tables: ['vitals(patient_id, record_date)'], solution: "WITH DailyVitals AS (SELECT DISTINCT patient_id, CAST(record_date AS DATE) as vital_day FROM vitals), Grouped AS (SELECT patient_id, vital_day, DATE(vital_day, '-' || (ROW_NUMBER() OVER (PARTITION BY patient_id ORDER BY vital_day)) || ' days') as streak_group FROM DailyVitals) SELECT patient_id, COUNT(*) as streak_length FROM Grouped GROUP BY patient_id, streak_group HAVING COUNT(*) >= 7;", setupSQL: "CREATE TABLE vitals(patient_id INT, record_date TEXT);" },
                { id: 'hch5', title: 'Most Common Co-morbidity', task: "Find the pair of diagnoses that most frequently occur together in the same patient.", tables: ['diagnoses(patient_id, condition)'], solution: "SELECT d1.condition, d2.condition, COUNT(*) as frequency FROM diagnoses d1 JOIN diagnoses d2 ON d1.patient_id = d2.patient_id AND d1.condition < d2.condition GROUP BY 1, 2 ORDER BY 3 DESC LIMIT 1;", setupSQL: "CREATE TABLE diagnoses(patient_id INT, condition TEXT); INSERT INTO diagnoses VALUES (1,'A','B'),(2,'A','B'),(3,'A','C');" },
                { id: 'hch6', title: 'New Patient Adherence', task: "For new patients, what percentage scheduled a follow-up appointment within 3 months of their first visit?", tables: ['appointments(patient_id, appt_date, appt_type)'], solution: "WITH FirstVisit AS (SELECT patient_id, MIN(appt_date) as first_visit_date FROM appointments GROUP BY patient_id), FollowUps AS (SELECT DISTINCT patient_id FROM appointments WHERE appt_type = 'Follow-up') SELECT CAST(COUNT(f.patient_id) AS REAL) * 100 / COUNT(fv.patient_id) FROM FirstVisit fv LEFT JOIN FollowUps f ON fv.patient_id = f.patient_id;", setupSQL: "CREATE TABLE appointments(patient_id INT, appt_date TEXT, appt_type TEXT);" },
                { id: 'hch7', title: 'Anomalous Lab Results', task: "Identify patients whose latest lab result for a specific test is more than 3 standard deviations away from their own average for that test.", tables: ['lab_results(patient_id, test_name, value)'], solution: "SELECT 'This requires window functions with statistical capabilities beyond basic SQLite.' as result;", setupSQL: "CREATE TABLE lab_results(patient_id INT, test_name TEXT, value REAL);" },
                { id: 'hch8', title: 'Physician Workload', task: "For each physician, calculate their average number of patient encounters per day.", tables: ['visits(doctor_id, visit_date)'], solution: "WITH DailyCounts AS (SELECT doctor_id, CAST(visit_date AS DATE) as day, COUNT(*) as daily_visits FROM visits GROUP BY 1, 2) SELECT doctor_id, AVG(daily_visits) FROM DailyCounts GROUP BY doctor_id;", setupSQL: "CREATE TABLE visits(doctor_id INT, visit_date TEXT); INSERT INTO visits VALUES (1, '2025-01-01'), (1, '2025-01-01'), (1, '2025-01-02');" },
                { id: 'hch9', title: 'Geographic Disease Hotspots', task: "Find the top 3 zip codes with the highest prevalence of a specific diagnosis.", tables: ['patients(patient_id, zip_code)', 'diagnoses(patient_id, condition)'], solution: "SELECT p.zip_code, COUNT(d.patient_id) FROM patients p JOIN diagnoses d ON p.patient_id = d.patient_id WHERE d.condition = 'Flu' GROUP BY 1 ORDER BY 2 DESC LIMIT 3;", setupSQL: "CREATE TABLE patients(patient_id INT, zip_code TEXT); CREATE TABLE diagnoses(patient_id INT, condition TEXT); INSERT INTO patients VALUES (1,'A'),(2,'B'),(3,'A'); INSERT INTO diagnoses VALUES (1,'Flu'),(2,'Cold'),(3,'Flu');" },
                { id: 'hch10', title: 'Time Between Diagnosis and Treatment', task: "For each patient with a specific condition, calculate the average time between their diagnosis date and their first treatment date.", tables: ['diagnoses(patient_id, condition, diagnosis_date)', 'treatments(patient_id, treatment_date)'], solution: "WITH FirstTreatments AS (SELECT patient_id, MIN(treatment_date) as first_treat_date FROM treatments GROUP BY 1) SELECT AVG(JULIANDAY(ft.first_treat_date) - JULIANDAY(d.diagnosis_date)) FROM diagnoses d JOIN FirstTreatments ft ON d.patient_id = ft.patient_id WHERE d.condition = 'Cancer';", setupSQL: "CREATE TABLE diagnoses(patient_id INT, condition TEXT, diagnosis_date TEXT); CREATE TABLE treatments(patient_id INT, treatment_date TEXT);" }
            ];
            // Streaming Questions
            themedQuestionBanks.streaming.easy = [
                { id: 'stre1', title: 'Find Active Subscribers', task: "Find all users with an 'active' subscription status.", tables: ['users(user_id, name, subscription_status)'], solution: "SELECT * FROM users WHERE subscription_status = 'active';", setupSQL: "CREATE TABLE users(user_id INT, name TEXT, subscription_status TEXT); INSERT INTO users VALUES (1, 'Alice', 'active'), (2, 'Bob', 'canceled');" },
                { id: 'stre2', title: 'Count Content by Genre', task: "Count the number of movies/shows for each genre.", tables: ['content(content_id, genre)'], solution: "SELECT genre, COUNT(content_id) FROM content GROUP BY genre;", setupSQL: "CREATE TABLE content(content_id INT, genre TEXT); INSERT INTO content VALUES (1, 'Comedy'), (2, 'Drama'), (3, 'Comedy');" },
                { id: 'stre3', title: 'Users with No Watch History', task: "Find all users who have not watched any content.", tables: ['users(user_id, name)', 'watch_history(user_id, content_id)'], solution: "SELECT u.name FROM users u LEFT JOIN watch_history w ON u.user_id = w.user_id WHERE w.content_id IS NULL;", setupSQL: "CREATE TABLE users(user_id INT, name TEXT); CREATE TABLE watch_history(user_id INT, content_id INT); INSERT INTO users VALUES (1, 'Watcher'), (2, 'New User'); INSERT INTO watch_history VALUES (1, 101);" },
                { id: 'stre4', title: 'Recently Added Content', task: "Retrieve all content added on or after '2025-08-01'.", tables: ['content(content_id, title, date_added)'], solution: "SELECT * FROM content WHERE date_added >= '2025-08-01';", setupSQL: "CREATE TABLE content(content_id INT, title TEXT, date_added TEXT); INSERT INTO content VALUES (1, 'Old Movie', '2025-07-20'), (2, 'New Show', '2025-08-05');" },
                { id: 'stre5', title: 'Users from a Specific Country', task: "Find all users from 'Germany'.", tables: ['users(user_id, name, country)'], solution: "SELECT * FROM users WHERE country = 'Germany';", setupSQL: "CREATE TABLE users(user_id INT, name TEXT, country TEXT); INSERT INTO users VALUES (1, 'Hans', 'Germany'), (2, 'Pierre', 'France');" },
                { id: 'stre6', title: 'Count Views per Show', task: "For each show, count the total number of views.", tables: ['watch_history(user_id, content_id)'], solution: "SELECT content_id, COUNT(user_id) FROM watch_history GROUP BY content_id;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT); INSERT INTO watch_history VALUES (1, 101), (2, 101), (1, 102);" },
                { id: 'stre7', title: 'Find Highly Rated Movies', task: "Select all movies with a rating of 9.0 or higher.", tables: ['content(title, rating)'], solution: "SELECT * FROM content WHERE rating >= 9.0;", setupSQL: "CREATE TABLE content(title TEXT, rating REAL); INSERT INTO content VALUES ('Good Movie', 9.2), ('Bad Movie', 4.5);" },
                { id: 'stre8', title: 'List Unique Content Ratings', task: "Get a list of all unique content ratings (e.g., G, PG, PG-13, R).", tables: ['content(title, content_rating)'], solution: "SELECT DISTINCT content_rating FROM content;", setupSQL: "CREATE TABLE content(title TEXT, content_rating TEXT); INSERT INTO content VALUES ('A', 'PG'), ('B', 'R'), ('C', 'PG');" },
                { id: 'stre9', title: 'Find a Specific Movie', task: "Retrieve all information for the movie titled 'The Matrix'.", tables: ['content(title, genre, release_year)'], solution: "SELECT * FROM content WHERE title = 'The Matrix';", setupSQL: "CREATE TABLE content(title TEXT, genre TEXT, release_year INT); INSERT INTO content VALUES ('The Matrix', 'Sci-Fi', 1999), ('Titanic', 'Drama', 1997);" },
                { id: 'stre10', title: 'Content Watched by a User', task: "Find all content watched by the user with `user_id` = 1.", tables: ['watch_history(user_id, content_id)'], solution: "SELECT content_id FROM watch_history WHERE user_id = 1;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT); INSERT INTO watch_history VALUES (1, 101), (2, 102), (1, 103);" }
            ];
            themedQuestionBanks.streaming.medium = [
                { id: 'strm1', title: 'Users Who Rated What They Watched', task: "Identify users who have left a rating for a movie they have watched.", tables: ['watch_history(user_id, content_id)', 'ratings(user_id, content_id)'], solution: "SELECT DISTINCT w.user_id FROM watch_history w JOIN ratings r ON w.user_id = r.user_id AND w.content_id = r.content_id;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT); CREATE TABLE ratings(user_id INT, content_id INT); INSERT INTO watch_history VALUES (1, 101), (2, 102); INSERT INTO ratings VALUES (1, 101);" },
                { id: 'strm2', title: 'Average User Rating', task: "Calculate the average rating given by all users across all content.", tables: ['ratings(user_id, rating)'], solution: "SELECT AVG(rating) FROM ratings;", setupSQL: "CREATE TABLE ratings(user_id INT, rating REAL); INSERT INTO ratings VALUES (1, 8.0), (2, 9.0), (1, 7.0);" },
                { id: 'strm3', title: 'Second Most Recently Watched', task: "For each user, find the second most recent piece of content they watched.", tables: ['watch_history(user_id, content_id, watch_date)'], solution: "WITH RankedHistory AS (SELECT user_id, content_id, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY watch_date DESC) as rn FROM watch_history) SELECT user_id, content_id FROM RankedHistory WHERE rn = 2;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT, watch_date TEXT); INSERT INTO watch_history VALUES (1,101,'2025-01-01'),(1,102,'2025-01-02'),(1,103,'2025-01-03');" },
                { id: 'strm4', title: 'Dormant Subscribers', task: "Find users with an active subscription who have not watched anything in the last 90 days (relative to '2025-08-11').", tables: ['users(user_id, name, subscription_status)', 'watch_history(user_id, watch_date)'], solution: "SELECT u.name FROM users u JOIN (SELECT user_id, MAX(watch_date) as last_watch FROM watch_history GROUP BY user_id) lw ON u.user_id = lw.user_id WHERE u.subscription_status = 'active' AND lw.last_watch < DATE('2025-08-11', '-90 days');", setupSQL: "CREATE TABLE users(user_id INT, name TEXT, subscription_status TEXT); CREATE TABLE watch_history(user_id INT, watch_date TEXT); INSERT INTO users VALUES (1,'A','active'),(2,'B','active'); INSERT INTO watch_history VALUES (1,'2025-08-01'),(2,'2025-01-01');" },
                { id: 'strm5', title: 'Genres and Their Average Rating', task: "List each genre and the average user rating for content within that genre.", tables: ['content(content_id, genre)', 'ratings(content_id, rating)'], solution: "SELECT c.genre, AVG(r.rating) FROM content c JOIN ratings r ON c.content_id = r.content_id GROUP BY c.genre;", setupSQL: "CREATE TABLE content(content_id INT, genre TEXT); CREATE TABLE ratings(content_id INT, rating REAL); INSERT INTO content VALUES (1, 'Comedy'), (2, 'Drama'); INSERT INTO ratings VALUES (1, 8), (2, 9), (1, 7);" },
                { id: 'strm6', title: 'Monthly New Subscriptions', task: "Calculate the number of new user subscriptions for each month in 2025.", tables: ['subscriptions(user_id, start_date)'], solution: "SELECT STRFTIME('%Y-%m', start_date) as month, COUNT(user_id) FROM subscriptions WHERE STRFTIME('%Y', start_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE subscriptions(user_id INT, start_date TEXT); INSERT INTO subscriptions VALUES (1, '2025-01-10'), (2, '2025-01-15'), (3, '2025-02-05');" },
                { id: 'strm7', title: 'Content Never Watched', task: "Find all content that has never been watched by any user.", tables: ['content(content_id, title)', 'watch_history(user_id, content_id)'], solution: "SELECT c.title FROM content c LEFT JOIN watch_history w ON c.content_id = w.content_id WHERE w.user_id IS NULL;", setupSQL: "CREATE TABLE content(content_id INT, title TEXT); CREATE TABLE watch_history(user_id INT, content_id INT); INSERT INTO content VALUES (101, 'Popular'), (102, 'Obscure'); INSERT INTO watch_history VALUES (1, 101);" },
                { id: 'strm8', title: 'Most Watched Movie', task: "Find the movie that has been watched the most times.", tables: ['content(content_id, title, type)', 'watch_history(content_id)'], solution: "SELECT c.title FROM content c JOIN watch_history w ON c.content_id = w.content_id WHERE c.type = 'Movie' GROUP BY c.title ORDER BY COUNT(w.user_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE content(content_id INT, title TEXT, type TEXT); CREATE TABLE watch_history(content_id INT); INSERT INTO content VALUES (1,'A','Movie'),(2,'B','Show'); INSERT INTO watch_history VALUES (1),(1),(2);" },
                { id: 'strm9', title: 'Average Watch Time per Session', task: "Calculate the average number of minutes a user watches content in a single session.", tables: ['watch_sessions(session_id, duration_minutes)'], solution: "SELECT AVG(duration_minutes) FROM watch_sessions;", setupSQL: "CREATE TABLE watch_sessions(session_id INT, duration_minutes INT); INSERT INTO watch_sessions VALUES (1, 30), (2, 90), (3, 45);" },
                { id: 'strm10', title: 'Subscription Tier Breakdown', task: "Count the number of users for each subscription tier (e.g., Basic, Standard, Premium).", tables: ['users(user_id, subscription_tier)'], solution: "SELECT subscription_tier, COUNT(user_id) FROM users GROUP BY subscription_tier;", setupSQL: "CREATE TABLE users(user_id INT, subscription_tier TEXT); INSERT INTO users VALUES (1, 'Premium'), (2, 'Basic'), (3, 'Premium');" }
            ];
            themedQuestionBanks.streaming.hard = [
                { id: 'strh1', title: 'Binge-Watchers', task: "Identify users who have watched more than 3 episodes of the same show on the same day.", tables: ['watch_history(user_id, show_name, episode_number, watch_date)'], solution: "SELECT user_id, show_name, CAST(watch_date AS DATE) FROM watch_history GROUP BY 1, 2, 3 HAVING COUNT(episode_number) > 3;", setupSQL: "CREATE TABLE watch_history(user_id INT, show_name TEXT, episode_number INT, watch_date TEXT); INSERT INTO watch_history VALUES (1, 'A', 1, '2025-01-01'),(1,'A',2,'2025-01-01'),(1,'A',3,'2025-01-01'),(1,'A',4,'2025-01-01');" },
                { id: 'strh2', title: 'Content Discovery Funnel', task: "For a specific movie, calculate how many users saw it on their homepage, how many clicked on it, and how many watched it.", tables: ['events(user_id, event_type, content_id)'], solution: "SELECT event_type, COUNT(DISTINCT user_id) FROM events WHERE content_id = 101 AND event_type IN ('impression', 'click', 'play') GROUP BY 1;", setupSQL: "CREATE TABLE events(user_id INT, event_type TEXT, content_id INT); INSERT INTO events VALUES (1,'impression',101),(2,'impression',101),(1,'click',101),(1,'play',101);" },
                { id: 'strh3', title: 'Running Total of Hours Watched', task: "Calculate the running total of hours of content watched across the entire platform each day.", tables: ['watch_history(watch_date, duration_minutes)'], solution: "WITH DailyHours AS (SELECT CAST(watch_date AS DATE) as day, SUM(duration_minutes)/60.0 as total_hours FROM watch_history GROUP BY 1) SELECT day, SUM(total_hours) OVER (ORDER BY day) FROM DailyHours;", setupSQL: "CREATE TABLE watch_history(watch_date TEXT, duration_minutes INT); INSERT INTO watch_history VALUES ('2025-01-01', 60), ('2025-01-01', 30), ('2025-01-02', 120);" },
                { id: 'strh4', title: 'Consecutive Day Watching Streak', task: "Find all users who have watched content on 7 or more consecutive days.", tables: ['watch_history(user_id, watch_date)'], solution: "WITH DailyWatches AS (SELECT DISTINCT user_id, CAST(watch_date AS DATE) as day FROM watch_history), Grouped AS (SELECT user_id, day, DATE(day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY day)) || ' days') as streak_group FROM DailyWatches) SELECT user_id, COUNT(*) as streak FROM Grouped GROUP BY user_id, streak_group HAVING COUNT(*) >= 7;", setupSQL: "CREATE TABLE watch_history(user_id INT, watch_date TEXT);" },
                { id: 'strh5', title: 'Most Commonly Paired Content', task: "Find the pair of movies/shows most frequently watched by the same user.", tables: ['watch_history(user_id, content_id)'], solution: "SELECT w1.content_id, w2.content_id, COUNT(*) as frequency FROM watch_history w1 JOIN watch_history w2 ON w1.user_id = w2.user_id AND w1.content_id < w2.content_id GROUP BY 1, 2 ORDER BY 3 DESC LIMIT 1;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT); INSERT INTO watch_history VALUES (1,101),(1,102),(2,101),(2,102),(3,101),(3,103);" },
                { id: 'strh6', title: 'Subscriber Cohort Retention', task: "For users who subscribed in Jan 2025, what percentage were still active subscribers in June 2025?", tables: ['subscriptions(user_id, start_date, status, status_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE subscriptions(user_id INT, start_date TEXT, status TEXT, status_date TEXT);" },
                { id: 'strh7', title: '"Rabbit Hole" Effect', task: "Identify users who start watching one piece of content and then watch at least 3 more pieces of content from the same genre within the same session.", tables: ['watch_history(user_id, session_id, genre)'], solution: "SELECT user_id, session_id, genre FROM watch_history GROUP BY 1, 2, 3 HAVING COUNT(*) >= 4;", setupSQL: "CREATE TABLE watch_history(user_id INT, session_id INT, genre TEXT); INSERT INTO watch_history VALUES (1,1,'Comedy'),(1,1,'Comedy'),(1,1,'Comedy'),(1,1,'Comedy');" },
                { id: 'strh8', title: 'Content Popularity by Region', task: "For each country, find the top-rated movie.", tables: ['content(content_id, title, type)', 'ratings(content_id, rating)', 'users(user_id, country)', 'ratings(user_id)'], solution: "WITH AvgRatings AS (SELECT c.content_id, c.title, u.country, AVG(r.rating) as avg_rating FROM content c JOIN ratings r ON c.content_id = r.content_id JOIN users u ON r.user_id = u.user_id WHERE c.type = 'Movie' GROUP BY 1,2,3), Ranked AS (SELECT *, ROW_NUMBER() OVER(PARTITION BY country ORDER BY avg_rating DESC) as rn FROM AvgRatings) SELECT country, title, avg_rating FROM Ranked WHERE rn = 1;", setupSQL: "CREATE TABLE content(content_id INT, title TEXT, type TEXT); CREATE TABLE ratings(user_id INT, content_id INT, rating REAL); CREATE TABLE users(user_id INT, country TEXT); INSERT INTO content VALUES (1,'A','Movie'),(2,'B','Movie'); INSERT INTO users VALUES (1,'USA'),(2,'CAN'); INSERT INTO ratings VALUES (1,1,9),(2,2,8),(1,2,7);" },
                { id: 'strh9', title: 'Personalized Recommendations (User-Based)', task: "Suggest content to a user that was highly rated by other users with a similar watch history.", tables: ['watch_history(user_id, content_id)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE watch_history(user_id INT, content_id INT);" },
                { id: 'strh10', title: 'Time to First Watch', task: "For each user, calculate the time difference in days between their sign-up date and the first time they watched any content.", tables: ['users(user_id, signup_date)', 'watch_history(user_id, watch_date)'], solution: "WITH FirstWatch AS (SELECT user_id, MIN(watch_date) as first_watch FROM watch_history GROUP BY 1) SELECT u.user_id, JULIANDAY(fw.first_watch) - JULIANDAY(u.signup_date) FROM users u JOIN FirstWatch fw ON u.user_id = fw.user_id;", setupSQL: "CREATE TABLE users(user_id INT, signup_date TEXT); CREATE TABLE watch_history(user_id INT, watch_date TEXT); INSERT INTO users VALUES (1, '2025-01-01'); INSERT INTO watch_history VALUES (1, '2025-01-05');" }
            ];
        }
        populateQuestions();
        
        // --- UI Helper Functions ---
        function getThemeForCompany(companyName) {
            const name = companyName.toLowerCase();
            if (['amazon', 'etsy', 'shopify', 'walmart', 'ebay'].some(term => name.includes(term))) return 'ecommerce';
            if (['facebook', 'twitter', 'instagram', 'linkedin', 'tiktok'].some(term => name.includes(term))) return 'social';
            if (['stripe', 'paypal', 'robinhood', 'chase', 'visa'].some(term => name.includes(term))) return 'fintech';
            if (['kaiser', 'cigna', 'epic', 'cerner', 'unitedhealth'].some(term => name.includes(term))) return 'healthcare';
            if (['netflix', 'youtube', 'hulu', 'disney', 'spotify'].some(term => name.includes(term))) return 'streaming';
            return 'saas';
        }

        function updateThemeAndMaxQuestions() {
            const companyName = companyChoices.getValue(true);
            const themeInput = document.getElementById('theme');
            const numQuestionsInput = document.getElementById('numQuestions');
            const difficulty = document.getElementById('difficulty').value;

            if (!companyName) {
                themeInput.value = '';
                numQuestionsInput.max = 0;
                numQuestionsInput.value = 0;
                return;
            }

            const theme = companyThemeMapping[companyName];
            themeInput.value = theme.charAt(0).toUpperCase() + theme.slice(1);
            
            const maxQuestions = themedQuestionBanks[theme][difficulty].length;
            numQuestionsInput.max = maxQuestions;
            if (parseInt(numQuestionsInput.value, 10) > maxQuestions) {
                numQuestionsInput.value = maxQuestions;
            }
        }

        // --- DB and UI Initialization ---
        async function initApp() {
            const companySelector = document.getElementById('company-selector');
            companyChoices = new Choices(companySelector, {
                allowHTML: false,
                searchEnabled: true,
                itemSelectText: '',
            });

            const companyData = [
                { value: 'Atlassian', label: 'Atlassian' }, { value: 'Google', label: 'Google' },
                { value: 'Amazon', label: 'Amazon' }, { value: 'Walmart', label: 'Walmart' },
                { value: 'Facebook', label: 'Facebook' }, { value: 'Twitter', label: 'Twitter' },
                { value: 'Stripe', label: 'Stripe' }, { value: 'PayPal', label: 'PayPal' },
                { value: 'Kaiser', label: 'Kaiser' }, { value: 'Cigna', label: 'Cigna' },
                { value: 'Netflix', label: 'Netflix' }, { value: 'Spotify', label: 'Spotify' }
            ];

            const themes = {
                saas: ['Atlassian', 'Google'],
                ecommerce: ['Amazon', 'Walmart'],
                social: ['Facebook', 'Twitter'],
                fintech: ['Stripe', 'PayPal'],
                healthcare: ['Kaiser', 'Cigna'],
                streaming: ['Netflix', 'Spotify']
            };

            Object.keys(themes).forEach(theme => {
                themes[theme].forEach(company => {
                    companyThemeMapping[company] = theme;
                });
            });

            companyChoices.setChoices(companyData, 'value', 'label', false);
            companyChoices.setValue(['Atlassian']); // Set a default value

            companySelector.addEventListener('change', updateThemeAndMaxQuestions);
            document.getElementById('difficulty').addEventListener('change', updateThemeAndMaxQuestions);

            try {
                SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                dbStatus.innerHTML = '<span class="text-green-600 font-semibold">Database Ready!</span>';
                document.getElementById('generateBtn').disabled = false;
                updateThemeAndMaxQuestions(); // Set initial theme and max questions
            } catch (err) {
                console.error(err);
                dbStatus.innerHTML = '<span class="text-red-600 font-semibold">Error loading database. Please refresh.</span>';
            }
        }
        initApp();

        // --- Quiz Generation ---
        function generateQuiz() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            errorDiv.textContent = '';

            try {
                const companyName = companyChoices.getValue(true);
                if (!companyName) {
                    errorDiv.textContent = 'Please select a company.';
                    return;
                }
                const difficulty = document.getElementById('difficulty').value;
                const numQuestions = parseInt(document.getElementById('numQuestions').value, 10);
                const container = document.getElementById('quiz-container');
                
                const theme = companyThemeMapping[companyName];
                const questionPool = [...themedQuestionBanks[theme][difficulty]];

                if (numQuestions > questionPool.length) {
                    errorDiv.textContent = `Only ${questionPool.length} questions are available for this selection.`;
                    return;
                }

                const selectedQuestions = questionPool.sort(() => 0.5 - Math.random()).slice(0, numQuestions);
                
                let allQuestionsHTML = '';
                activeQuizData = {}; 

                selectedQuestions.forEach((q, index) => {
                    activeQuizData[q.id] = { solution: q.solution, setupSQL: q.setupSQL };
                    allQuestionsHTML += `
                        <div id="${q.id}" class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold text-gray-800">${index + 1}. ${q.title}</h2>
                                <div class="flex space-x-2">
                                    <span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full capitalize">${theme}</span>
                                    <span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full capitalize">${difficulty}</span>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-600">${q.task.replace('{companyName}', `<strong>${companyName}</strong>`)}</p>
                            <div class="mt-4 bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                                <p><strong>Tables:</strong></p>
                                ${q.tables.map(t => `<code class="block mt-1">${t}</code>`).join('')}
                            </div>
                            <div class="mt-4">
                                <label for="solution-${q.id}" class="block text-sm font-medium text-gray-700 mb-1">Your Solution:</label>
                                <textarea id="solution-${q.id}" rows="8" class="w-full p-3 font-mono text-sm border-gray-300 rounded-lg shadow-sm"></textarea>
                            </div>
                            <div class="mt-4 flex items-center space-x-4">
                                <button onclick="checkSolution('${q.id}')" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Check Solution</button>
                                <span id="result-${q.id}" class="font-semibold"></span>
                            </div>
                            <details class="mt-4">
                                <summary class="cursor-pointer text-blue-600 hover:underline">Show/Hide Official Solution</summary>
                                <div class="mt-2 border-t pt-4">
                                    <pre><code class="language-sql">${q.solution}</code></pre>
                                </div>
                            </details>
                        </div>
                    `;
                });
                
                container.innerHTML = allQuestionsHTML;
                Prism.highlightAll();

            } catch (err) {
                errorDiv.textContent = `An error occurred: ${err.message}`;
                console.error(err);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Quiz';
            }
        }

        // --- Solution Validation ---
        function setupTestData(setupSQL) {
            db = new SQL.Database(); 
            db.run(setupSQL);
        }

        function checkSolution(questionId) {
            if (!db || !SQL) {
                alert("Database is not ready. Please wait.");
                return;
            }

            const quizData = activeQuizData[questionId];
            setupTestData(quizData.setupSQL);
            
            const userAnswer = document.getElementById(`solution-${questionId}`).value;
            const resultSpan = document.getElementById(`result-${questionId}`);
            
            let userResult, correctResult;

            try {
                const res = db.exec(userAnswer);
                userResult = res.length > 0 ? JSON.stringify(res[0].values.sort()) : "[]";
            } catch (e) {
                resultSpan.textContent = `Error: ${e.message}`;
                resultSpan.className = 'font-semibold text-red-600 text-sm';
                return;
            }

            try {
                const res = db.exec(quizData.solution);
                correctResult = res.length > 0 ? JSON.stringify(res[0].values.sort()) : "[]";
            } catch (e) {
                console.error("Error in official solution:", e);
                resultSpan.textContent = 'An internal error occurred.';
                resultSpan.className = 'font-semibold text-orange-600';
                return;
            }
            
            if (userResult === correctResult) {
                resultSpan.textContent = 'Correct! ';
                resultSpan.className = 'font-semibold text-green-600';
            } else {
                resultSpan.textContent = 'Incorrect Result. ';
                resultSpan.className = 'font-semibold text-red-600';
            }
        }
    </script>
</body>
</html>

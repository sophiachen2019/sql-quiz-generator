<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic SQL Quiz Generator</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- sql.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />

    <!-- Choices.js for the multi-select search box -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        pre[class*="language-"] { border-radius: 0.5rem; padding: 1.25rem; }
        summary { list-style: none; }
        summary::-webkit-details-marker { display: none; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        /* Styling for Choices.js */
        .choices__inner { background-color: white; border-radius: 0.375rem; border: 1px solid #D1D5DB; }
        .choices__list--dropdown { border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">Dynamic SQL Quiz Generator</h1>
            <p class="mt-2 text-lg text-gray-600">Customize your practice quiz below.</p>
            <div id="db-status" class="mt-4 text-sm text-gray-500">Loading database...</div>
        </header>

        <!-- Setup Form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-12">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quiz Setup</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="md:col-span-2">
                    <label for="company-selector" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <select id="company-selector"></select>
                </div>
                 <div>
                    <label for="theme" class="block text-sm font-medium text-gray-700">Company Theme</label>
                    <input type="text" id="theme" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" disabled>
                </div>
                <div>
                    <label for="difficulty" class="block text-sm font-medium text-gray-700">Difficulty</label>
                    <select id="difficulty" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div class="lg:col-span-4">
                    <label for="numQuestions" class="block text-sm font-medium text-gray-700">Number of Questions</label>
                    <input type="number" id="numQuestions" value="5" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="generateBtn" onclick="generateQuiz()" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75" disabled>Generate Quiz</button>
                <div id="error-message" class="mt-4 text-red-600 font-semibold text-sm"></div>
            </div>
        </div>

        <!-- Quiz Container -->
        <main id="quiz-container" class="space-y-12"></main>
    </div>

    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        let SQL;
        let db;
        let companyChoices;
        const dbStatus = document.getElementById('db-status');
        const errorDiv = document.getElementById('error-message');
        let activeQuizData = {};

        // --- Question Bank (fully populated) ---
        const themedQuestionBanks = { saas: {easy:[], medium:[], hard:[]}, ecommerce: {easy:[], medium:[], hard:[]}, social: {easy:[], medium:[], hard:[]}, fintech: {easy:[], medium:[], hard:[]}, healthcare: {easy:[], medium:[], hard:[]}, streaming: {easy:[], medium:[], hard:[]} };
        const companyThemeMapping = {};

        // --- Populate Question Bank ---
        function populateQuestions() {
            // SaaS Questions
            themedQuestionBanks.saas.easy = [
                { id: 'se1', title: 'Find All Active Users', task: "Retrieve the `user_id` and `user_name` of all users at {companyName} with an 'active' status.", tables: ['users(user_id, user_name, status)'], solution: "SELECT user_id, user_name FROM users WHERE status = 'active';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, status TEXT); INSERT INTO users VALUES (1, 'Alice', 'active'), (2, 'Bob', 'inactive'), (3, 'Charlie', 'active');" },
                { id: 'se2', title: 'Count Issues by Type', task: "Count the number of issues for each `issue_type`.", tables: ['issues(issue_id, issue_type)'], solution: "SELECT issue_type, COUNT(issue_id) AS issue_count FROM issues GROUP BY issue_type;", setupSQL: "CREATE TABLE issues (issue_id INT, issue_type TEXT); INSERT INTO issues VALUES (101, 'Bug'), (102, 'Feature'), (103, 'Bug'), (104, 'Task');" },
                { id: 'se3', title: 'Find Projects with No Issues', task: "Identify all projects that have no issues reported in them.", tables: ['projects(project_id, project_name)', 'issues(issue_id, project_id)'], solution: "SELECT p.project_id, p.project_name FROM projects p LEFT JOIN issues i ON p.project_id = i.project_id WHERE i.issue_id IS NULL;", setupSQL: "CREATE TABLE projects (project_id INT, project_name TEXT); CREATE TABLE issues (issue_id INT, project_id INT); INSERT INTO projects VALUES (1, 'Jira'), (2, 'Confluence'), (3, 'Bitbucket'); INSERT INTO issues VALUES (101, 1), (102, 3);" },
                { id: 'se4', title: 'Find Recent Comments', task: "Retrieve all comments created on or after '2025-08-01'.", tables: ['comments(comment_id, comment_text, created_at)'], solution: "SELECT * FROM comments WHERE created_at >= '2025-08-01';", setupSQL: "CREATE TABLE comments (comment_id INT, comment_text TEXT, created_at TEXT); INSERT INTO comments VALUES (1, 'First comment', '2025-07-31'), (2, 'Second comment', '2025-08-01'), (3, 'Third comment', '2025-08-02');" },
                { id: 'se5', title: 'Users with a Specific Email Domain', task: "Find all users whose email address ends with '@example.com'.", tables: ['users(user_id, user_name, email)'], solution: "SELECT user_id, user_name FROM users WHERE email LIKE '%@example.com';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, email TEXT); INSERT INTO users VALUES (1, 'Alice', 'alice@example.com'), (2, 'Bob', 'bob@work.com'), (3, 'Charlie', 'charlie@example.com');" },
                { id: 'se6', title: 'Count Comments per Issue', task: "For each issue, count the total number of comments.", tables: ['comments(comment_id, issue_id)'], solution: "SELECT issue_id, COUNT(comment_id) AS comment_count FROM comments GROUP BY issue_id;", setupSQL: "CREATE TABLE comments (comment_id INT, issue_id INT); INSERT INTO comments VALUES (1, 101), (2, 101), (3, 102), (4, 101);" },
                { id: 'se7', title: 'Find Critical Priority Issues', task: "Select all issues that have a 'Critical' priority.", tables: ['issues(issue_id, summary, priority)'], solution: "SELECT * FROM issues WHERE priority = 'Critical';", setupSQL: "CREATE TABLE issues (issue_id INT, summary TEXT, priority TEXT); INSERT INTO issues VALUES (1, 'UI Glitch', 'Medium'), (2, 'System Crash', 'Critical'), (3, 'Typo in docs', 'Low');" },
                { id: 'se8', title: 'List Unique Project Statuses', task: "Get a list of all unique statuses a project can have.", tables: ['projects(project_id, status)'], solution: "SELECT DISTINCT status FROM projects;", setupSQL: "CREATE TABLE projects (project_id INT, status TEXT); INSERT INTO projects VALUES (1, 'Active'), (2, 'On Hold'), (3, 'Active'), (4, 'Archived');" },
                { id: 'se9', title: 'Find a Specific User', task: "Retrieve all information for the user named 'Bob'.", tables: ['users(user_id, user_name, email)'], solution: "SELECT * FROM users WHERE user_name = 'Bob';", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT, email TEXT); INSERT INTO users VALUES (1, 'Alice', 'a@a.com'), (2, 'Bob', 'b@b.com');" },
                { id: 'se10', title: 'Issues Assigned to a User', task: "Find all issues assigned to the user with `assignee_id` = 1.", tables: ['issues(issue_id, summary, assignee_id)'], solution: "SELECT issue_id, summary FROM issues WHERE assignee_id = 1;", setupSQL: "CREATE TABLE issues (issue_id INT, summary TEXT, assignee_id INT); INSERT INTO issues VALUES (101, 'Fix login', 1), (102, 'Update docs', 2), (103, 'Deploy fix', 1);" }
            ];
            themedQuestionBanks.saas.medium = [
                { id: 'sm1', title: 'Users Who Commented on Their Own Issues', task: "Identify users from {companyName} who have commented on an issue they also reported. Return the `user_id` and `user_name`.", tables: ['users(user_id, user_name)', 'issues(issue_id, reporter_id)', 'comments(comment_id, issue_id, author_id)'], solution: "SELECT DISTINCT u.user_id, u.user_name FROM users u JOIN issues i ON u.user_id = i.reporter_id JOIN comments c ON i.issue_id = c.issue_id AND u.user_id = c.author_id;", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT); CREATE TABLE issues (issue_id INT, reporter_id INT); CREATE TABLE comments (comment_id INT, issue_id INT, author_id INT); INSERT INTO users VALUES (1, 'Alice'), (2, 'Bob'); INSERT INTO issues VALUES (101, 1), (102, 2); INSERT INTO comments VALUES (1, 101, 1), (2, 101, 2), (3, 102, 1);" },
                { id: 'sm2', title: 'Average Comments Before Closure', task: "Calculate the average number of comments an issue receives before it is marked 'Closed'.", tables: ['comments(comment_id, issue_id)', "issue_history(history_id, issue_id, status)"], solution: "WITH CommentCounts AS (SELECT issue_id, COUNT(comment_id) as num_comments FROM comments GROUP BY issue_id), ClosedIssues AS (SELECT DISTINCT issue_id FROM issue_history WHERE status = 'Closed') SELECT AVG(cc.num_comments) FROM CommentCounts cc JOIN ClosedIssues ci ON cc.issue_id = ci.issue_id;", setupSQL: "CREATE TABLE comments (comment_id INT, issue_id INT); CREATE TABLE issue_history (history_id INT, issue_id INT, status TEXT); INSERT INTO comments VALUES (1, 101), (2, 101), (3, 102); INSERT INTO issue_history VALUES (1, 101, 'Closed'), (2, 102, 'Closed'), (3, 103, 'Open');" },
                { id: 'sm3', title: 'Second Most Recent Comment', task: "For each user, find their second most recent comment.", tables: ['comments(user_id, comment_text, created_at)'], solution: "WITH RankedComments AS (SELECT user_id, comment_text, ROW_NUMBER() OVER(PARTITION BY user_id ORDER BY created_at DESC) as rn FROM comments) SELECT user_id, comment_text FROM RankedComments WHERE rn = 2;", setupSQL: "CREATE TABLE comments (user_id INT, comment_text TEXT, created_at TEXT); INSERT INTO comments VALUES (1, 'First', '2025-01-01'), (1, 'Second', '2025-01-02'), (1, 'Third', '2025-01-03'), (2, 'A', '2025-01-04'), (2, 'B', '2025-01-05');" },
                { id: 'sm4', title: 'Inactive Users', task: "Find users who have not created an issue or a comment in the last 90 days (relative to '2025-08-11').", tables: ['users(user_id, user_name)', 'issues(reporter_id, created_at)', 'comments(author_id, created_at)'], solution: "WITH LastActivity AS (SELECT user_id, MAX(activity_date) as last_date FROM (SELECT reporter_id as user_id, created_at as activity_date FROM issues UNION ALL SELECT author_id, created_at FROM comments) AS AllActivity GROUP BY user_id) SELECT u.user_id, u.user_name FROM users u LEFT JOIN LastActivity la ON u.user_id = la.user_id WHERE la.last_date IS NULL OR la.last_date < DATE('2025-08-11', '-90 days');", setupSQL: "CREATE TABLE users(user_id INT, user_name TEXT); CREATE TABLE issues(reporter_id INT, created_at TEXT); CREATE TABLE comments(author_id INT, created_at TEXT); INSERT INTO users VALUES (1, 'Active User'), (2, 'Inactive User'); INSERT INTO issues VALUES (1, '2025-08-01'); INSERT INTO comments VALUES (1, '2025-08-02');" },
                { id: 'sm5', title: 'Projects and Their User Count', task: "List each project and the number of unique users who have commented on it.", tables: ['projects(project_id, project_name)', 'comments(project_id, user_id)'], solution: "SELECT p.project_name, COUNT(DISTINCT c.user_id) as user_count FROM projects p LEFT JOIN comments c ON p.project_id = c.project_id GROUP BY p.project_name;", setupSQL: "CREATE TABLE projects(project_id INT, project_name TEXT); CREATE TABLE comments(project_id INT, user_id INT); INSERT INTO projects VALUES (1, 'Jira'), (2, 'Confluence'); INSERT INTO comments VALUES (1, 1), (1, 2), (1, 1), (2, 3);" },
                { id: 'sm6', title: 'Monthly Active Users (MAU)', task: "Calculate the number of unique active users for each month in 2025.", tables: ['activity_log(user_id, event_date)'], solution: "SELECT STRFTIME('%Y-%m', event_date) as month, COUNT(DISTINCT user_id) as mau FROM activity_log WHERE STRFTIME('%Y', event_date) = '2025' GROUP BY month;", setupSQL: "CREATE TABLE activity_log(user_id INT, event_date TEXT); INSERT INTO activity_log VALUES (1, '2025-01-10'), (2, '2025-01-15'), (1, '2025-01-20'), (3, '2025-02-05'), (1, '2025-02-10');" },
                { id: 'sm7', title: 'Issues with No Comments', task: "Find all issues that have not received any comments.", tables: ['issues(issue_id, summary)', 'comments(comment_id, issue_id)'], solution: "SELECT i.issue_id, i.summary FROM issues i LEFT JOIN comments c ON i.issue_id = c.issue_id WHERE c.comment_id IS NULL;", setupSQL: "CREATE TABLE issues(issue_id INT, summary TEXT); CREATE TABLE comments(comment_id INT, issue_id INT); INSERT INTO issues VALUES (101, 'Bug A'), (102, 'Feature B'); INSERT INTO comments VALUES (1, 101);" },
                { id: 'sm8', title: 'User with Most Bug Reports', task: "Find the user who has reported the most 'Bug' type issues.", tables: ['users(user_id, user_name)', 'issues(reporter_id, issue_type)'], solution: "SELECT u.user_name FROM users u JOIN issues i ON u.user_id = i.reporter_id WHERE i.issue_type = 'Bug' GROUP BY u.user_name ORDER BY COUNT(i.issue_id) DESC LIMIT 1;", setupSQL: "CREATE TABLE users(user_id INT, user_name TEXT); CREATE TABLE issues(reporter_id INT, issue_type TEXT); INSERT INTO users VALUES(1, 'Alice'), (2, 'Bob'); INSERT INTO issues VALUES (1, 'Bug'), (1, 'Bug'), (2, 'Feature'), (2, 'Bug');" },
                { id: 'sm9', title: 'Average Time to First Comment', task: "Calculate the average time (in hours) between an issue's creation and its first comment.", tables: ['issues(issue_id, created_at)', 'comments(issue_id, created_at)'], solution: "WITH FirstComments AS (SELECT issue_id, MIN(created_at) as first_comment_time FROM comments GROUP BY issue_id) SELECT AVG((JULIANDAY(fc.first_comment_time) - JULIANDAY(i.created_at)) * 24) as avg_hours_to_comment FROM issues i JOIN FirstComments fc ON i.issue_id = fc.issue_id;", setupSQL: "CREATE TABLE issues(issue_id INT, created_at TEXT); CREATE TABLE comments(issue_id INT, created_at TEXT); INSERT INTO issues VALUES (101, '2025-08-01 10:00:00'); INSERT INTO comments VALUES (101, '2025-08-01 12:30:00');" },
                { id: 'sm10', title: 'Subscription Plan Breakdown', task: "Count the number of users on each subscription plan.", tables: ['users(user_id, plan_id)', 'plans(plan_id, plan_name)'], solution: "SELECT p.plan_name, COUNT(u.user_id) as user_count FROM plans p JOIN users u ON p.plan_id = u.plan_id GROUP BY p.plan_name;", setupSQL: "CREATE TABLE users(user_id INT, plan_id INT); CREATE TABLE plans(plan_id INT, plan_name TEXT); INSERT INTO plans VALUES (1, 'Free'), (2, 'Premium'); INSERT INTO users VALUES (1, 1), (2, 2), (3, 1), (4, 2), (5, 2);" }
            ];
            themedQuestionBanks.saas.hard = [
                { id: 'sh1', title: 'Power User Identification', task: "Identify 'Power Users' at {companyName} who have commented on > 2 distinct projects and resolved >= 3 issues.", tables: ['users(user_id, user_name)', 'comments(project_id, user_id)', "issue_history(issue_id, status, changed_by_user_id)"], solution: "WITH UserComments AS (SELECT user_id, COUNT(DISTINCT project_id) AS distinct_projects FROM comments GROUP BY user_id HAVING COUNT(DISTINCT project_id) > 2), UserResolutions AS (SELECT changed_by_user_id AS user_id, COUNT(DISTINCT issue_id) AS resolved_issues FROM issue_history WHERE status = 'Closed' GROUP BY changed_by_user_id HAVING COUNT(DISTINCT issue_id) >= 3) SELECT u.user_id, u.user_name FROM users u JOIN UserComments uc ON u.user_id = uc.user_id JOIN UserResolutions ur ON u.user_id = ur.user_id;", setupSQL: "CREATE TABLE users (user_id INT, user_name TEXT); CREATE TABLE comments (project_id INT, user_id INT); CREATE TABLE issue_history (issue_id INT, status TEXT, changed_by_user_id INT); INSERT INTO users VALUES (1, 'Alice'); INSERT INTO comments VALUES (1, 1), (2, 1), (3, 1); INSERT INTO issue_history VALUES (101, 'Closed', 1), (102, 'Closed', 1), (103, 'Closed', 1);" },
                { id: 'sh2', title: 'Issue Resolution Funnel Analysis', task: "For each `issue_id`, determine if it followed the standard path: 'Open' -> 'In Progress'.", tables: ["issue_history(issue_id, status, changed_at)"], solution: "WITH StatusFlow AS (SELECT issue_id, status, LEAD(status, 1) OVER (PARTITION BY issue_id ORDER BY changed_at) AS next_status FROM issue_history) SELECT issue_id, MAX(CASE WHEN status = 'Open' AND next_status = 'In Progress' THEN 1 ELSE 0 END) AS followed_path FROM StatusFlow GROUP BY issue_id ORDER BY issue_id;", setupSQL: "CREATE TABLE issue_history (issue_id INT, status TEXT, changed_at TEXT); INSERT INTO issue_history VALUES (101, 'Open', '2025-08-01 10:00:00'), (101, 'In Progress', '2025-08-01 11:00:00'), (102, 'Open', '2025-08-02 10:00:00');" },
                { id: 'sh3', title: 'Running Total of Daily Issues', task: "Calculate the running total of issues created each day.", tables: ['issues(issue_id, created_at)'], solution: "WITH DailyCounts AS (SELECT CAST(created_at AS DATE) as creation_date, COUNT(issue_id) as daily_count FROM issues GROUP BY creation_date) SELECT creation_date, SUM(daily_count) OVER (ORDER BY creation_date) as running_total_issues FROM DailyCounts;", setupSQL: "CREATE TABLE issues (issue_id INT, created_at TEXT); INSERT INTO issues VALUES (1, '2025-08-01'), (2, '2025-08-01'), (3, '2025-08-02'), (4, '2025-08-03');" },
                { id: 'sh4', title: 'Consecutive Day Login Streaks', task: "Find all users who have logged in for 3 or more consecutive days.", tables: ['logins(user_id, login_date)'], solution: "WITH DailyLogins AS (SELECT DISTINCT user_id, CAST(login_date AS DATE) as login_day FROM logins), GroupedLogins AS (SELECT user_id, login_day, DATE(login_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY login_day)) || ' days') as streak_group FROM DailyLogins) SELECT user_id, COUNT(*) as streak_length FROM GroupedLogins GROUP BY user_id, streak_group HAVING COUNT(*) >= 3;", setupSQL: "CREATE TABLE logins(user_id INT, login_date TEXT); INSERT INTO logins VALUES (1, '2025-01-01'), (1, '2025-01-02'), (1, '2025-01-03'), (2, '2025-01-01'), (2, '2025-01-03');" },
                { id: 'sh5', title: 'Fastest Issue Solvers', task: "Find the user who, on average, takes the least amount of time to move an issue from 'In Progress' to 'Closed'.", tables: ['issue_history(issue_id, status, changed_at, changed_by_user_id)'], solution: "WITH InProgress AS (SELECT issue_id, changed_at as progress_time FROM issue_history WHERE status = 'In Progress'), Closed AS (SELECT issue_id, changed_at as closed_time, changed_by_user_id FROM issue_history WHERE status = 'Closed') SELECT c.changed_by_user_id, AVG(JULIANDAY(c.closed_time) - JULIANDAY(p.progress_time)) as avg_solve_time FROM InProgress p JOIN Closed c ON p.issue_id = c.issue_id GROUP BY c.changed_by_user_id ORDER BY avg_solve_time LIMIT 1;", setupSQL: "CREATE TABLE issue_history(issue_id INT, status TEXT, changed_at TEXT, changed_by_user_id INT); INSERT INTO issue_history VALUES (101, 'In Progress', '2025-01-01 10:00', 1), (101, 'Closed', '2025-01-01 12:00', 1), (102, 'In Progress', '2025-01-02 10:00', 2), (102, 'Closed', '2025-01-02 15:00', 2);" },
                { id: 'sh6', title: 'Monthly Churn Rate', task: "Calculate the monthly user churn rate. Churn is defined as the number of users who ended their subscription in a month divided by the total active users at the start of that month.", tables: ['subscriptions(user_id, start_date, end_date)'], solution: "SELECT 'This is a complex multi-step calculation not easily represented in a single SQLite query for this simple setup.' as result;", setupSQL: "CREATE TABLE subscriptions(user_id INT, start_date TEXT, end_date TEXT);" },
                { id: 'sh7', title: 'User Adoption of a New Feature', task: "For a feature launched on '2025-02-01', calculate the daily percentage of the total user base that has adopted it.", tables: ['users(user_id)', 'feature_usage(user_id, feature_name, used_at)'], solution: "WITH DailyAdopters AS (SELECT CAST(used_at AS DATE) as adoption_date, COUNT(DISTINCT user_id) as daily_adopters FROM feature_usage WHERE feature_name = 'New Feature' AND used_at >= '2025-02-01' GROUP BY adoption_date), TotalUsers AS (SELECT COUNT(*) as total FROM users) SELECT da.adoption_date, CAST(da.daily_adopters AS REAL) * 100 / tu.total FROM DailyAdopters da, TotalUsers tu;", setupSQL: "CREATE TABLE users(user_id INT); CREATE TABLE feature_usage(user_id INT, feature_name TEXT, used_at TEXT); INSERT INTO users VALUES (1),(2),(3),(4); INSERT INTO feature_usage VALUES (1, 'New Feature', '2025-02-01'), (2, 'New Feature', '2025-02-01'), (3, 'New Feature', '2025-02-02');" },
                { id: 'sh8', title: 'Team Velocity', task: "For each team, calculate the total number of 'story points' completed per week.", tables: ['issues(issue_id, team_id, story_points, completed_at)'], solution: "SELECT team_id, STRFTIME('%Y-%W', completed_at) as week, SUM(story_points) as velocity FROM issues WHERE completed_at IS NOT NULL GROUP BY team_id, week;", setupSQL: "CREATE TABLE issues(issue_id INT, team_id INT, story_points INT, completed_at TEXT); INSERT INTO issues VALUES (1, 1, 5, '2025-01-05'), (2, 1, 3, '2025-01-06'), (3, 2, 8, '2025-01-07');" },
                { id: 'sh9', title: 'Islands and Gaps in Activity', task: "Find the start and end dates of continuous periods of user activity (logins).", tables: ['logins(user_id, login_date)'], solution: "WITH DailyLogins AS (SELECT DISTINCT user_id, CAST(login_date AS DATE) as login_day FROM logins), GroupedLogins AS (SELECT user_id, login_day, DATE(login_day, '-' || (ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY login_day)) || ' days') as streak_group FROM DailyLogins) SELECT user_id, MIN(login_day) as streak_start, MAX(login_day) as streak_end FROM GroupedLogins GROUP BY user_id, streak_group;", setupSQL: "CREATE TABLE logins(user_id INT, login_date TEXT); INSERT INTO logins VALUES (1, '2025-01-01'), (1, '2025-01-02'), (1, '2025-01-04'), (1, '2025-01-05');" },
                { id: 'sh10', title: 'Second Purchase Analysis', task: "For each user, find the time difference in days between their first and second purchase.", tables: ['purchases(user_id, purchase_date)'], solution: "WITH RankedPurchases AS (SELECT user_id, purchase_date, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY purchase_date) as rn FROM purchases), FirstTwo AS (SELECT user_id, purchase_date, rn FROM RankedPurchases WHERE rn <= 2) SELECT user_id, JULIANDAY(MAX(purchase_date)) - JULIANDAY(MIN(purchase_date)) as days_between_purchases FROM FirstTwo GROUP BY user_id HAVING COUNT(*) = 2;", setupSQL: "CREATE TABLE purchases(user_id INT, purchase_date TEXT); INSERT INTO purchases VALUES (1, '2025-01-01'), (1, '2025-01-10'), (2, '2025-02-01');" }
            ];
            const themes = ['ecommerce', 'social', 'fintech', 'healthcare', 'streaming'];
            themes.forEach(theme => {
                themedQuestionBanks[theme].easy = Array.from({length: 10}, (_, i) => ({ ...themedQuestionBanks.saas.easy[i], id: `${theme.slice(0,2)}e${i+1}` }));
                themedQuestionBanks[theme].medium = Array.from({length: 10}, (_, i) => ({ ...themedQuestionBanks.saas.medium[i], id: `${theme.slice(0,2)}m${i+1}` }));
                themedQuestionBanks[theme].hard = Array.from({length: 10}, (_, i) => ({ ...themedQuestionBanks.saas.hard[i], id: `${theme.slice(0,2)}h${i+1}` }));
            });
        }
        populateQuestions();
        
        // --- UI Helper Functions ---
        function getThemeForCompany(companyName) {
            const name = companyName.toLowerCase();
            if (['amazon', 'etsy', 'shopify', 'walmart', 'ebay'].some(term => name.includes(term))) return 'ecommerce';
            if (['facebook', 'twitter', 'instagram', 'linkedin', 'tiktok'].some(term => name.includes(term))) return 'social';
            if (['stripe', 'paypal', 'robinhood', 'chase', 'visa'].some(term => name.includes(term))) return 'fintech';
            if (['kaiser', 'cigna', 'epic', 'cerner', 'unitedhealth'].some(term => name.includes(term))) return 'healthcare';
            if (['netflix', 'youtube', 'hulu', 'disney', 'spotify'].some(term => name.includes(term))) return 'streaming';
            return 'saas';
        }

        function updateThemeAndMaxQuestions() {
            const companyName = companyChoices.getValue(true);
            const themeInput = document.getElementById('theme');
            const numQuestionsInput = document.getElementById('numQuestions');
            const difficulty = document.getElementById('difficulty').value;

            if (!companyName) {
                themeInput.value = '';
                numQuestionsInput.max = 0;
                numQuestionsInput.value = 0;
                return;
            }

            const theme = companyThemeMapping[companyName];
            themeInput.value = theme.charAt(0).toUpperCase() + theme.slice(1);
            
            const maxQuestions = themedQuestionBanks[theme][difficulty].length;
            numQuestionsInput.max = maxQuestions;
            if (parseInt(numQuestionsInput.value, 10) > maxQuestions) {
                numQuestionsInput.value = maxQuestions;
            }
        }

        // --- DB and UI Initialization ---
        async function initApp() {
            const companySelector = document.getElementById('company-selector');
            companyChoices = new Choices(companySelector, {
                allowHTML: false,
                searchEnabled: true,
                itemSelectText: '',
            });

            const companyData = [
                { value: 'Atlassian', label: 'Atlassian' }, { value: 'Google', label: 'Google' },
                { value: 'Amazon', label: 'Amazon' }, { value: 'Walmart', label: 'Walmart' },
                { value: 'Facebook', label: 'Facebook' }, { value: 'Twitter', label: 'Twitter' },
                { value: 'Stripe', label: 'Stripe' }, { value: 'PayPal', label: 'PayPal' },
                { value: 'Kaiser', label: 'Kaiser' }, { value: 'Cigna', label: 'Cigna' },
                { value: 'Netflix', label: 'Netflix' }, { value: 'Spotify', label: 'Spotify' }
            ];

            const themes = {
                saas: ['Atlassian', 'Google'],
                ecommerce: ['Amazon', 'Walmart'],
                social: ['Facebook', 'Twitter'],
                fintech: ['Stripe', 'PayPal'],
                healthcare: ['Kaiser', 'Cigna'],
                streaming: ['Netflix', 'Spotify']
            };

            Object.keys(themes).forEach(theme => {
                themes[theme].forEach(company => {
                    companyThemeMapping[company] = theme;
                });
            });

            companyChoices.setChoices(companyData, 'value', 'label', false);
            companyChoices.setValue(['Atlassian']); // Set a default value

            companySelector.addEventListener('change', updateThemeAndMaxQuestions);
            document.getElementById('difficulty').addEventListener('change', updateThemeAndMaxQuestions);

            try {
                SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                dbStatus.innerHTML = '<span class="text-green-600 font-semibold">Database Ready!</span>';
                document.getElementById('generateBtn').disabled = false;
                updateThemeAndMaxQuestions(); // Set initial theme and max questions
            } catch (err) {
                console.error(err);
                dbStatus.innerHTML = '<span class="text-red-600 font-semibold">Error loading database. Please refresh.</span>';
            }
        }
        initApp();

        // --- Quiz Generation ---
        function generateQuiz() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            errorDiv.textContent = '';

            try {
                const companyName = companyChoices.getValue(true);
                if (!companyName) {
                    errorDiv.textContent = 'Please select a company.';
                    return;
                }
                const difficulty = document.getElementById('difficulty').value;
                const numQuestions = parseInt(document.getElementById('numQuestions').value, 10);
                const container = document.getElementById('quiz-container');
                
                const theme = companyThemeMapping[companyName];
                const questionPool = [...themedQuestionBanks[theme][difficulty]];

                if (numQuestions > questionPool.length) {
                    errorDiv.textContent = `Only ${questionPool.length} questions are available for this selection.`;
                    return;
                }

                const selectedQuestions = questionPool.sort(() => 0.5 - Math.random()).slice(0, numQuestions);
                
                let allQuestionsHTML = '';
                activeQuizData = {}; 

                selectedQuestions.forEach((q, index) => {
                    activeQuizData[q.id] = { solution: q.solution, setupSQL: q.setupSQL };
                    allQuestionsHTML += `
                        <div id="${q.id}" class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <h2 class="text-2xl font-semibold text-gray-800">${index + 1}. ${q.title}</h2>
                                <div class="flex space-x-2">
                                    <span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full capitalize">${theme}</span>
                                    <span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full capitalize">${difficulty}</span>
                                </div>
                            </div>
                            <p class="mt-2 text-gray-600">${q.task.replace('{companyName}', `<strong>${companyName}</strong>`)}</p>
                            <div class="mt-4 bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                                <p><strong>Tables:</strong></p>
                                ${q.tables.map(t => `<code class="block mt-1">${t}</code>`).join('')}
                            </div>
                            <div class="mt-4">
                                <label for="solution-${q.id}" class="block text-sm font-medium text-gray-700 mb-1">Your Solution:</label>
                                <textarea id="solution-${q.id}" rows="8" class="w-full p-3 font-mono text-sm border-gray-300 rounded-lg shadow-sm"></textarea>
                            </div>
                            <div class="mt-4 flex items-center space-x-4">
                                <button onclick="checkSolution('${q.id}')" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Check Solution</button>
                                <span id="result-${q.id}" class="font-semibold"></span>
                            </div>
                            <details class="mt-4">
                                <summary class="cursor-pointer text-blue-600 hover:underline">Show/Hide Official Solution</summary>
                                <div class="mt-2 border-t pt-4">
                                    <pre><code class="language-sql">${q.solution}</code></pre>
                                </div>
                            </details>
                        </div>
                    `;
                });
                
                container.innerHTML = allQuestionsHTML;
                Prism.highlightAll();

            } catch (err) {
                errorDiv.textContent = `An error occurred: ${err.message}`;
                console.error(err);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Quiz';
            }
        }

        // --- Solution Validation ---
        function setupTestData(setupSQL) {
            db = new SQL.Database(); 
            db.run(setupSQL);
        }

        function checkSolution(questionId) {
            if (!db || !SQL) {
                alert("Database is not ready. Please wait.");
                return;
            }

            const quizData = activeQuizData[questionId];
            setupTestData(quizData.setupSQL);
            
            const userAnswer = document.getElementById(`solution-${questionId}`).value;
            const resultSpan = document.getElementById(`result-${questionId}`);
            
            let userResult, correctResult;

            try {
                const res = db.exec(userAnswer);
                userResult = res.length > 0 ? JSON.stringify(res[0].values.sort()) : "[]";
            } catch (e) {
                resultSpan.textContent = `Error: ${e.message}`;
                resultSpan.className = 'font-semibold text-red-600 text-sm';
                return;
            }

            try {
                const res = db.exec(quizData.solution);
                correctResult = res.length > 0 ? JSON.stringify(res[0].values.sort()) : "[]";
            } catch (e) {
                console.error("Error in official solution:", e);
                resultSpan.textContent = 'An internal error occurred.';
                resultSpan.className = 'font-semibold text-orange-600';
                return;
            }
            
            if (userResult === correctResult) {
                resultSpan.textContent = 'Correct! ✅';
                resultSpan.className = 'font-semibold text-green-600';
            } else {
                resultSpan.textContent = 'Incorrect Result. ❌';
                resultSpan.className = 'font-semibold text-red-600';
            }
        }
    </script>
</body>
</html>
